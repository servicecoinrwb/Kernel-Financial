<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoBank | Future of Personal Finance</title>
    
    <!-- Tailwind CSS (Updated script to suppress warning) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .gradient-text {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .input-field {
            @apply w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all;
        }
        .nav-active {
            @apply text-blue-600 bg-blue-50;
        }
        .nav-inactive {
            @apply text-slate-500 hover:text-slate-800 hover:bg-slate-50;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen relative overflow-x-hidden">

    <!-- Background Decoration -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-[500px] h-[500px] bg-indigo-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Navigation -->
    <nav class="w-full px-6 py-4 flex justify-between items-center glass-panel sticky top-0 z-50">
        <div class="flex items-center gap-4 md:gap-8">
            <div class="flex items-center gap-2 mr-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">N</div>
                <span class="text-xl font-bold tracking-tight text-slate-900 hidden md:block">NeoBank</span>
            </div>
            
            <!-- Tab Switcher -->
            <div id="nav-tabs" class="hidden flex gap-1 md:gap-2 overflow-x-auto">
                <button onclick="switchView('dashboard')" id="tab-dashboard" class="nav-active px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i> My Account
                </button>
                <button onclick="switchView('ecosystem')" id="tab-ecosystem" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="network" class="w-4 h-4"></i> Ecosystem
                </button>
                <button onclick="switchView('solver')" id="tab-solver" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="briefcase" class="w-4 h-4"></i> Solver
                </button>
                <button onclick="switchView('admin')" id="tab-admin" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="shield" class="w-4 h-4"></i> Admin
                </button>
            </div>
        </div>

        <div id="wallet-section">
            <button id="connect-btn" onclick="connectWallet()" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-full font-medium transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4"></i>
                <span class="hidden md:inline">Connect Wallet</span>
                <span class="md:hidden">Connect</span>
            </button>
            <div id="wallet-info" class="hidden flex items-center gap-4">
                <span id="user-address" class="text-sm font-medium text-slate-600 bg-white px-3 py-1.5 rounded-full border border-slate-200"></span>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- View: Landing / Connect -->
        <div id="view-landing" class="flex flex-col items-center justify-center min-h-[60vh] text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6 text-slate-900 tracking-tight">
                Banking, <span class="gradient-text">Reinvented</span> on Chain.
            </h1>
            <p class="text-lg text-slate-500 max-w-2xl mb-10 leading-relaxed">
                Your personal smart contract checking account. Earn yield directly from the Kernel, set daily spending limits, and own your financial infrastructure.
            </p>
            <button onclick="connectWallet()" class="bg-blue-600 hover:bg-blue-700 text-white text-lg px-8 py-4 rounded-full font-semibold transition-all shadow-xl shadow-blue-500/30 flex items-center gap-2">
                Get Started <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- View: Create Account -->
        <div id="view-create" class="hidden flex flex-col items-center justify-center min-h-[60vh] max-w-lg mx-auto text-center">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6">
                <i data-lucide="user-plus" class="w-8 h-8"></i>
            </div>
            <h2 class="text-3xl font-bold mb-3 text-slate-900">Create Your Account</h2>
            <p class="text-slate-500 mb-8">
                Deploy your personal `CheckingAccount` smart contract. This will be your secure vault for managing assets and interacting with the ecosystem.
            </p>
            <button id="create-btn" onclick="createAccount()" class="w-full bg-slate-900 hover:bg-slate-800 text-white text-lg px-6 py-4 rounded-xl font-medium transition-all shadow-lg flex items-center justify-center gap-2">
                <span id="create-btn-text">Deploy Smart Account</span>
                <span id="create-btn-spinner" class="hidden">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                </span>
            </button>
        </div>

        <!-- View: Dashboard (My Account) -->
        <div id="view-dashboard" class="hidden">
            <!-- Header Info -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">My Overview</h2>
                    <p class="text-slate-500 text-sm">Managing Smart Account: <span id="contract-address" class="font-mono text-blue-600 bg-blue-50 px-2 py-0.5 rounded ml-1 cursor-pointer" onclick="copyAddress()">0x...</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshData()" class="p-2 text-slate-400 hover:text-blue-600 transition-colors bg-white border border-slate-200 rounded-lg shadow-sm">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    <button onclick="toggleModal('modal-topup')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-md shadow-blue-500/20 flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Top Up
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Checking Balance -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="wallet" class="w-24 h-24 text-blue-600"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">Checking Balance</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-4">$<span id="bal-checking">0.00</span> <span class="text-lg text-slate-400 font-normal">USDC</span></h3>
                        <div class="flex gap-2">
                            <button onclick="openTransferModal()" class="flex-1 bg-slate-900 text-white text-sm py-2 rounded-lg hover:bg-slate-800 transition-colors">Transfer</button>
                        </div>
                    </div>
                </div>

                <!-- Savings Balance -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="piggy-bank" class="w-24 h-24 text-emerald-600"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">Savings Vault</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-4"><span id="bal-savings">0.00</span> <span class="text-lg text-slate-400 font-normal">Shares</span></h3>
                        <div class="flex gap-2">
                            <button onclick="openSavingsModal('deposit')" class="flex-1 bg-emerald-600 text-white text-sm py-2 rounded-lg hover:bg-emerald-700 transition-colors">Invest</button>
                            <button onclick="openSavingsModal('withdraw')" class="flex-1 bg-white border border-slate-200 text-slate-700 text-sm py-2 rounded-lg hover:bg-slate-50 transition-colors">Withdraw</button>
                        </div>
                    </div>
                </div>

                <!-- Security / Limits -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="shield-check" class="w-24 h-24 text-purple-600"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-sm font-medium text-slate-500">Daily Limit</p>
                            <button onclick="toggleModal('modal-limit')" class="text-xs text-blue-600 hover:underline">Edit</button>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="limit-daily">--</span></h3>
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                            <div id="limit-bar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500">Spent Today: $<span id="limit-spent">0.00</span></p>
                    </div>
                </div>
            </div>

            <!-- Activity List -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 min-h-[200px]">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Recent Activity</h3>
                    <div id="activity-loading" class="hidden">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-slate-400"></i>
                    </div>
                </div>
                <div id="activity-list" class="space-y-4">
                    <!-- Activity items injected by JS -->
                    <div class="flex items-center justify-center text-slate-400 py-8 flex-col gap-2 opacity-50">
                        <i data-lucide="activity" class="w-8 h-8"></i>
                        <p>No transactions yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Ecosystem (Vault & Kernel) -->
        <div id="view-ecosystem" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">Protocol Intelligence</h2>
                <p class="text-slate-500">Real-time data from the InvestorVault and Kernel Solvers.</p>
            </div>

            <!-- Global Vault Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- TVL -->
                <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-400 mb-1">Total Value Locked</p>
                        <h3 class="text-3xl font-bold mb-2">$<span id="eco-tvl">Loading...</span></h3>
                        <p class="text-xs text-slate-400">Total Assets Managed</p>
                    </div>
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="landmark" class="w-24 h-24"></i>
                    </div>
                </div>

                <!-- Share Price -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Share Price</p>
                    <h3 class="text-3xl font-bold text-slate-900 mb-2" id="eco-share-price">Loading...</h3>
                    <p class="text-xs text-green-600 font-medium flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> 
                        1 Share = <span id="eco-share-ratio">--</span> USDC
                    </p>
                </div>

                <!-- Kernel Util -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Capital Deployed</p>
                    <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="eco-deployed">Loading...</span></h3>
                    <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
                        <div id="eco-util-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Utilization: <span id="eco-util-pct">0%</span></p>
                </div>
            </div>

            <!-- Solver Inspector -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8">
                <div class="max-w-xl">
                    <h3 class="text-xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5 text-blue-600"></i> Solver Inspector
                    </h3>
                    <p class="text-sm text-slate-500 mb-6">Verify if an address is a whitelisted Solver and check their active debt principal.</p>
                    
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="input-solver-addr" placeholder="Solver Address (0x...)" class="flex-1 border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="checkSolver()" class="bg-slate-900 text-white px-6 py-3 rounded-lg font-medium hover:bg-slate-800 transition-colors">Check</button>
                    </div>

                    <!-- Result Panel -->
                    <div id="solver-result" class="hidden bg-slate-50 rounded-xl p-6 border border-slate-200">
                        <div class="flex items-center gap-3 mb-4">
                            <div id="solver-status-icon" class="w-8 h-8 rounded-full flex items-center justify-center">
                                <!-- Icon injected via JS -->
                            </div>
                            <div>
                                <h4 id="solver-status-text" class="font-bold text-slate-900">--</h4>
                                <p class="text-xs text-slate-500">Status</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wide">Active Principal</p>
                                <p id="solver-principal" class="text-lg font-mono font-medium text-slate-800">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wide">Address</p>
                                <p id="solver-addr-display" class="text-sm font-mono text-slate-600 truncate">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Solver (Loan Repayment) -->
        <div id="view-solver" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">Solver Portal</h2>
                <p class="text-slate-500">Manage your outstanding loans and repayments to the Kernel.</p>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Market Liquidity -->
                <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-400 mb-1">Available Liquidity</p>
                        <h3 class="text-3xl font-bold mb-2">$<span id="solver-available-liquidity">Loading...</span></h3>
                        <p class="text-xs text-slate-400">Funds ready for deployment</p>
                    </div>
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="droplet" class="w-24 h-24"></i>
                    </div>
                </div>

                <!-- My Debt Position -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">My Active Debt</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="my-principal">0.00</span></h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded">10% Fee</span>
                            <p class="text-xs text-slate-400">Applied on repayment</p>
                        </div>
                    </div>
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="alert-circle" class="w-24 h-24 text-orange-600"></i>
                    </div>
                </div>
            </div>

            <!-- Repay Form -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-2xl mx-auto">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Repay Loan</h3>
                
                <label class="block text-sm font-medium text-slate-700 mb-2">Principal to Repay</label>
                <input type="number" id="input-repay-principal" placeholder="0.00" oninput="calculateRepayment()" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div class="space-y-2 mb-6 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-500">Principal</span>
                        <span class="font-medium">$<span id="calc-principal">0.00</span></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Interest Fee (10%)</span>
                        <span class="font-medium text-orange-600">+$<span id="calc-fee">0.00</span></span>
                    </div>
                    <div class="pt-2 border-t border-slate-100 flex justify-between font-bold text-slate-900">
                        <span>Total Cost</span>
                        <span>$<span id="calc-total">0.00</span></span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="approveUSDCForKernel()" class="flex-1 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 py-3 rounded-lg font-medium transition-colors">1. Approve</button>
                    <button onclick="executeRepay()" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-medium transition-colors">2. Repay</button>
                </div>
            </div>
        </div>

        <!-- View: Admin (Whitelist & Operations) -->
        <div id="view-admin" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">Admin Console</h2>
                <p class="text-slate-500">Restricted access. Manage Kernel liquidity and permissions.</p>
            </div>

            <!-- Lending Operations (New) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto mb-8">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Lending Operations</h3>
                
                <!-- Fund Kernel -->
                <div class="mb-8 pb-8 border-b border-slate-100">
                    <h4 class="font-semibold text-slate-800 mb-2">1. Fund Kernel</h4>
                    <p class="text-xs text-slate-500 mb-4">Move idle assets from InvestorVault to Kernel so they can be deployed.</p>
                    <div class="flex gap-2">
                        <input type="number" id="input-push-amount" placeholder="Amount (USDC)" class="flex-1 border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="executePushCapital()" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Push</button>
                    </div>
                </div>

                <!-- Issue Loan -->
                <div>
                    <h4 class="font-semibold text-slate-800 mb-2">2. Issue Loan (Deploy Capital)</h4>
                    <p class="text-xs text-slate-500 mb-4">Disburse funds from Kernel to Solver.</p>
                    
                    <label class="block text-xs font-medium text-slate-600 mb-1">Solver Address</label>
                    <input type="text" id="input-loan-solver" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm mb-3 focus:ring-2 focus:ring-blue-500 outline-none">
                    
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-600 mb-1">Amount</label>
                            <input type="number" id="input-loan-amount" placeholder="0.00" class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-600 mb-1">Invoice Ref</label>
                            <input type="text" id="input-loan-ref" placeholder="INV-001" class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    <button onclick="executeDeployCapital()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i> Deploy Funds
                    </button>
                </div>
            </div>

            <!-- Manage Solvers (Existing) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto mb-8">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Manage Solvers</h3>
                
                <label class="block text-sm font-medium text-slate-700 mb-2">Solver Wallet Address</label>
                <input type="text" id="input-admin-solver" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-6 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setSolverStatus(true)" class="bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Whitelist
                    </button>
                    <button onclick="setSolverStatus(false)" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="ban" class="w-4 h-4"></i> Revoke
                    </button>
                </div>
            </div>

            <!-- Manage Investors (New) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Manage Investors</h3>
                <p class="text-sm text-slate-500 mb-4">Whitelist user Checking Accounts to allow deposits into the Vault.</p>
                
                <label class="block text-sm font-medium text-slate-700 mb-2">Account Address</label>
                <input type="text" id="input-admin-investor" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-6 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setInvestorStatus(true)" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Whitelist
                    </button>
                    <button onclick="setInvestorStatus(false)" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="ban" class="w-4 h-4"></i> Revoke
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals (TopUp, Transfer, Savings, Limit, Toast) - SAME AS BEFORE -->
    <!-- Top Up Modal -->
    <div id="modal-topup" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-topup')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Top Up Account</h3>
            <label class="block text-sm font-medium text-slate-700 mb-2">Amount (USDC)</label>
            <input type="number" id="input-topup" placeholder="1000" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="executeTopUp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">Send Funds</button>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="modal-transfer" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-transfer')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Send Payment</h3>
            <label class="block text-sm font-medium text-slate-700 mb-2">Recipient Address</label>
            <input type="text" id="input-transfer-to" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <label class="block text-sm font-medium text-slate-700 mb-2">Amount (USDC)</label>
            <div class="relative mb-4">
                <input type="number" id="input-transfer-amount" placeholder="0.00" class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none pr-16">
                <button onclick="fillMax('input-transfer-amount', 'checking')" class="absolute right-2 top-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold px-2 py-1.5 rounded transition-colors">MAX</button>
            </div>
            <button onclick="executeTransfer()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-medium transition-colors">Confirm Transfer</button>
        </div>
    </div>

    <!-- Savings Modal -->
    <div id="modal-savings" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-savings')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 id="savings-title" class="text-xl font-bold mb-2">Invest in Vault</h3>
            <p id="savings-desc" class="text-sm text-slate-500 mb-4">Move funds to the Investor Kernel to earn yield.</p>
            <label class="block text-sm font-medium text-slate-700 mb-2">Amount</label>
            <div class="relative mb-2">
                <input type="number" id="input-savings-amount" placeholder="0.00" class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none pr-16">
                <button onclick="fillMax('input-savings-amount', 'savings-dynamic')" class="absolute right-2 top-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold px-2 py-1.5 rounded transition-colors">MAX</button>
            </div>
            <p class="text-xs text-slate-400 mb-4 text-right">Slippage protection enabled (1%)</p>
            <button id="savings-btn" onclick="executeSavingsAction()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium transition-colors">Confirm</button>
        </div>
    </div>

    <!-- Limit Modal -->
    <div id="modal-limit" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-limit')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Set Daily Spending Limit</h3>
            <p class="text-sm text-slate-500 mb-4">Protect your funds by capping daily outflows. Set to 0 to disable.</p>
            <label class="block text-sm font-medium text-slate-700 mb-2">Daily Limit (USDC)</label>
            <input type="number" id="input-limit" placeholder="1000" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="executeSetLimit()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium transition-colors">Update Limit</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center gap-3">
        <i id="toast-icon" data-lucide="info" class="w-5 h-5 text-blue-400"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- CONFIGURATION ---
        const FACTORY_ADDRESS = "0x7090825ed699229Fe60E59163E439737E22b67dE";
        
        // Minimal ABIs
        const FACTORY_ABI = [
            "function getAccount(address user) view returns (address)",
            "function createAccount() returns (address)",
            "function usdc() view returns (address)",
            "function INVESTOR_VAULT() view returns (address)",
            "function KERNEL() view returns (address)"
        ];

        const ACCOUNT_ABI = [
            "function getCheckingBalance() view returns (uint256)",
            "function getSavingsBalance() view returns (uint256)",
            "function pay(address to, uint256 amount)",
            "function depositToSavings(uint256 amount, uint256 minShares)",
            "function withdrawFromSavings(uint256 shareAmount, uint256 minAssets)",
            "function dailyLimit() view returns (uint256)",
            "function spentToday() view returns (uint256)",
            "function setDailyLimit(uint256 _limit)",
            "function usdc() view returns (address)",
            "event PaymentSent(address indexed to, uint256 amount)",
            "event DepositedToSavings(uint256 amount, uint256 sharesMinted)",
            "event WithdrawnFromSavings(uint256 sharesBurned, uint256 assetsReceived)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)"
        ];

        // ADDED: isWhitelisted for checks AND setInvestorStatus for admin AND pushCapitalToKernel
        const VAULT_ABI = [
            "function totalManagedAssets() view returns (uint256)",
            "function totalShares() view returns (uint256)",
            "function capitalInKernel() view returns (uint256)",
            "function isWhitelisted(address) view returns (bool)",
            "function setInvestorStatus(address investor, bool status)",
            "function pushCapitalToKernel(uint256 amount)"
        ];

        // ADDED: Methods for Repay Loan, Admin Whitelist, and Deploy Capital
        const KERNEL_ABI = [
            "function whitelistedSolvers(address) view returns (bool)",
            "function activePrincipal(address) view returns (uint256)",
            "function repayLoan(uint256 principal, uint256 fee)",
            "function setSolver(address solver, bool status)",
            "function deployCapital(address solver, uint256 amount, string invoiceHash)"
        ];

        // --- STATE ---
        let provider, signer, userAddress;
        let factoryContract, accountContract, usdcContract;
        let vaultContract, vaultContractSigner, kernelContract, kernelContractSigner;
        let accountAddress = ethers.constants.AddressZero;
        let vaultAddress = ethers.constants.AddressZero;
        let kernelAddress = ethers.constants.AddressZero;
        let currentSavingsAction = 'deposit'; 
        let currentCheckingBal = "0";
        let currentSavingsBal = "0";

        // --- INIT ---
        lucide.createIcons();

        // --- NAVIGATION ---
        function switchView(viewName) {
            const views = ['dashboard', 'ecosystem', 'solver', 'admin'];
            
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                const tab = document.getElementById('tab-' + v);
                
                if (v === viewName) {
                    el.classList.remove('hidden');
                    tab.classList.add('nav-active');
                    tab.classList.remove('nav-inactive');
                } else {
                    el.classList.add('hidden');
                    tab.classList.remove('nav-active');
                    tab.classList.add('nav-inactive');
                }
            });

            if(viewName === 'ecosystem') loadEcosystemData();
            if(viewName === 'solver') loadSolverData();
        }

        // --- WALLET CONNECTION ---
        async function connectWallet() {
            if (!window.ethereum) return showToast("Metamask not found!", "error");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('wallet-info').classList.remove('hidden');
                document.getElementById('user-address').innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
                
                initContracts();
            } catch (err) {
                console.error(err);
                showToast("Connection failed", "error");
            }
        }

        async function initContracts() {
            factoryContract = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
            try {
                // Fetch Global Addrs
                vaultAddress = await factoryContract.INVESTOR_VAULT();
                kernelAddress = await factoryContract.KERNEL();

                vaultContract = new ethers.Contract(vaultAddress, VAULT_ABI, provider);
                vaultContractSigner = new ethers.Contract(vaultAddress, VAULT_ABI, signer); // Write capability for Admin
                kernelContract = new ethers.Contract(kernelAddress, KERNEL_ABI, provider); // Read-only
                kernelContractSigner = new ethers.Contract(kernelAddress, KERNEL_ABI, signer); // Write

                // Check for User Account
                const acct = await factoryContract.getAccount(userAddress);
                if (acct !== ethers.constants.AddressZero) {
                    accountAddress = acct;
                    loadDashboard();
                    document.getElementById('nav-tabs').classList.remove('hidden');
                } else {
                    document.getElementById('view-landing').classList.add('hidden');
                    document.getElementById('view-create').classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
                showToast("Error initializing", "error");
            }
        }

        // --- CREATE ACCOUNT ---
        async function createAccount() {
            try {
                setBtnLoading('create-btn', true);
                const tx = await factoryContract.createAccount();
                showToast("Deploying Account... Please wait.");
                await tx.wait();
                const acct = await factoryContract.getAccount(userAddress);
                accountAddress = acct;
                setBtnLoading('create-btn', false);
                document.getElementById('view-create').classList.add('hidden');
                document.getElementById('nav-tabs').classList.remove('hidden');
                loadDashboard();
                showToast("Account Deployed Successfully!", "success");
            } catch (err) {
                console.error(err);
                setBtnLoading('create-btn', false);
                showToast("Deployment failed", "error");
            }
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-create').classList.add('hidden');
            switchView('dashboard');
            document.getElementById('contract-address').innerText = `${accountAddress.substring(0,6)}...${accountAddress.substring(38)}`;
            
            accountContract = new ethers.Contract(accountAddress, ACCOUNT_ABI, signer);
            const usdcAddr = await accountContract.usdc();
            usdcContract = new ethers.Contract(usdcAddr, ERC20_ABI, signer);

            refreshData();
            loadActivityFeed();
        }

        async function refreshData() {
            if (!accountContract) return;
            try {
                const checkingBalBN = await accountContract.getCheckingBalance();
                const savingsBalBN = await accountContract.getSavingsBalance();
                const limitBN = await accountContract.dailyLimit();
                const spentBN = await accountContract.spentToday();

                const checkingFmt = ethers.utils.formatUnits(checkingBalBN, 6);
                const savingsFmt = ethers.utils.formatUnits(savingsBalBN, 6); 
                currentCheckingBal = checkingFmt;
                currentSavingsBal = savingsFmt;

                const limitFmt = ethers.utils.formatUnits(limitBN, 6);
                const spentFmt = ethers.utils.formatUnits(spentBN, 6);

                document.getElementById('bal-checking').innerText = formatMoney(checkingFmt);
                document.getElementById('bal-savings').innerText = formatMoney(savingsFmt);
                
                if (parseFloat(limitFmt) === 0) {
                    document.getElementById('limit-daily').innerText = "Unlimited";
                    document.getElementById('limit-bar').style.width = "0%";
                } else {
                    document.getElementById('limit-daily').innerText = formatMoney(limitFmt);
                    document.getElementById('limit-spent').innerText = formatMoney(spentFmt);
                    const pct = Math.min((parseFloat(spentFmt) / parseFloat(limitFmt)) * 100, 100);
                    document.getElementById('limit-bar').style.width = `${pct}%`;
                    if(pct > 90) document.getElementById('limit-bar').classList.add('bg-red-500');
                    else document.getElementById('limit-bar').classList.remove('bg-red-500');
                }
                loadActivityFeed();
            } catch (err) { console.error("Refresh failed", err); }
        }

        async function loadActivityFeed() {
            const listEl = document.getElementById('activity-list');
            const loader = document.getElementById('activity-loading');
            if(listEl.children.length <= 1) loader.classList.remove('hidden');

            try {
                const paymentFilter = accountContract.filters.PaymentSent();
                const depositFilter = accountContract.filters.DepositedToSavings();
                const withdrawFilter = accountContract.filters.WithdrawnFromSavings();

                const [pEvts, dEvts, wEvts] = await Promise.all([
                    accountContract.queryFilter(paymentFilter),
                    accountContract.queryFilter(depositFilter),
                    accountContract.queryFilter(withdrawFilter)
                ]);

                const allEvents = [
                    ...pEvts.map(e => ({ type: 'payment', block: e.blockNumber, hash: e.transactionHash, amount: ethers.utils.formatUnits(e.args.amount, 6), to: e.args.to })),
                    ...dEvts.map(e => ({ type: 'deposit', block: e.blockNumber, hash: e.transactionHash, amount: ethers.utils.formatUnits(e.args.amount, 6) })),
                    ...wEvts.map(e => ({ type: 'withdraw', block: e.blockNumber, hash: e.transactionHash, amount: ethers.utils.formatUnits(e.args.assetsReceived, 6) }))
                ];

                allEvents.sort((a, b) => b.block - a.block);

                if (allEvents.length === 0) {
                     listEl.innerHTML = `<div class="flex items-center justify-center text-slate-400 py-8 flex-col gap-2 opacity-50"><i data-lucide="activity" class="w-8 h-8"></i><p>No transactions yet</p></div>`;
                } else {
                    listEl.innerHTML = allEvents.map(evt => {
                        let icon, title, desc, colorClass;
                        if (evt.type === 'payment') { icon='arrow-up-right'; colorClass='bg-slate-100 text-slate-600'; title='Transfer Sent'; desc=`To: ${evt.to.substring(0,6)}...`; }
                        else if (evt.type === 'deposit') { icon='piggy-bank'; colorClass='bg-emerald-100 text-emerald-600'; title='Invested in Vault'; desc='Moved to Savings'; }
                        else { icon='arrow-down-left'; colorClass='bg-blue-100 text-blue-600'; title='Withdrawn from Vault'; desc='Moved to Checking'; }
                        
                        return `<div class="flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-100">
                            <div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                            <div><p class="font-semibold text-slate-800">${title}</p><p class="text-xs text-slate-500">${desc}</p></div></div>
                            <div class="text-right"><p class="font-bold text-slate-900">${evt.type==='withdraw'?'+':'-'}$${formatMoney(evt.amount)}</p><a href="https://etherscan.io/tx/${evt.hash}" target="_blank" class="text-xs text-blue-500 hover:underline">View Tx</a></div></div>`;
                    }).join('');
                    lucide.createIcons();
                }
            } catch (err) { console.error("Error loading activity", err); } finally { loader.classList.add('hidden'); }
        }

        // --- ECOSYSTEM ---
        async function loadEcosystemData() {
            if(!vaultContract) return;
            try {
                const totalAssets = await vaultContract.totalManagedAssets();
                const totalShares = await vaultContract.totalShares();
                const capitalInKernel = await vaultContract.capitalInKernel();

                const assetsFmt = parseFloat(ethers.utils.formatUnits(totalAssets, 6));
                const sharesFmt = parseFloat(ethers.utils.formatUnits(totalShares, 6));
                let price = 1.0;
                if(sharesFmt > 0) price = assetsFmt / sharesFmt;

                const kernelFmt = parseFloat(ethers.utils.formatUnits(capitalInKernel, 6));
                let util = 0;
                if(assetsFmt > 0) util = (kernelFmt / assetsFmt) * 100;

                document.getElementById('eco-tvl').innerText = formatMoney(assetsFmt);
                document.getElementById('eco-deployed').innerText = formatMoney(kernelFmt);
                document.getElementById('eco-share-price').innerText = "$" + price.toFixed(4);
                document.getElementById('eco-share-ratio').innerText = price.toFixed(4);
                document.getElementById('eco-util-bar').style.width = `${util}%`;
                document.getElementById('eco-util-pct').innerText = `${util.toFixed(1)}%`;
            } catch(err) { console.error("Eco data failed", err); }
        }

        // --- SOLVER LOGIC ---
        async function loadSolverData() {
            if(!kernelContract || !userAddress) return;
            try {
                const principal = await kernelContract.activePrincipal(userAddress);
                const prinFmt = ethers.utils.formatUnits(principal, 6);
                document.getElementById('my-principal').innerText = formatMoney(prinFmt);

                // Fetch Available Liquidity from Kernel USDC Balance
                const kernelBal = await usdcContract.balanceOf(kernelAddress);
                const kernelBalFmt = ethers.utils.formatUnits(kernelBal, 6);
                document.getElementById('solver-available-liquidity').innerText = formatMoney(kernelBalFmt);

            } catch(err) { console.error("Solver data failed", err); }
        }

        function calculateRepayment() {
            const input = document.getElementById('input-repay-principal').value;
            const amount = parseFloat(input || 0);
            
            // 10% Interest Calculation
            const fee = amount * 0.10;
            const total = amount + fee;

            document.getElementById('calc-principal').innerText = formatMoney(amount);
            document.getElementById('calc-fee').innerText = formatMoney(fee);
            document.getElementById('calc-total').innerText = formatMoney(total);
        }

        async function approveUSDCForKernel() {
            // Solvers pay from their EOA, not the Checking Account contract
            const amount = document.getElementById('input-repay-principal').value;
            if(!amount) return;
            
            // Approval must cover Principal + 10% Fee
            const total = parseFloat(amount) * 1.10;
            const totalWei = ethers.utils.parseUnits(total.toFixed(6), 6);

            try {
                showToast("Approving USDC...");
                const tx = await usdcContract.approve(kernelAddress, totalWei);
                await tx.wait();
                showToast("Approved! You can now repay.", "success");
            } catch(err) {
                console.error(err);
                showToast("Approval failed", "error");
            }
        }

        async function executeRepay() {
            const amount = document.getElementById('input-repay-principal').value;
            if(!amount) return;

            const principalWei = ethers.utils.parseUnits(amount, 6);
            
            // Calculate Fee Wei (10%)
            // We use JS math here for demo, but ideal to use BigNumber math
            const feeWei = principalWei.div(10); 

            try {
                showToast("Repaying Loan...");
                // EOA calls Kernel directly
                const tx = await kernelContractSigner.repayLoan(principalWei, feeWei);
                await tx.wait();
                showToast("Loan Repaid Successfully!", "success");
                loadSolverData(); // Refresh UI
                document.getElementById('input-repay-principal').value = "";
                calculateRepayment();
            } catch(err) {
                console.error(err);
                showToast("Repayment failed", "error");
            }
        }

        // --- ADMIN LOGIC ---
        async function setSolverStatus(status) {
            const addr = document.getElementById('input-admin-solver').value;
            if(!ethers.utils.isAddress(addr)) return showToast("Invalid Address", "error");

            try {
                showToast(status ? "Whitelisting Solver..." : "Revoking Solver...");
                const tx = await kernelContractSigner.setSolver(addr, status);
                await tx.wait();
                showToast("Solver Status Updated!", "success");
            } catch(err) {
                console.error(err);
                showToast("Admin Action Failed", "error");
            }
        }

        async function setInvestorStatus(status) {
            const addr = document.getElementById('input-admin-investor').value;
            if(!ethers.utils.isAddress(addr)) return showToast("Invalid Address", "error");

            try {
                showToast(status ? "Whitelisting Investor..." : "Revoking Investor...");
                const tx = await vaultContractSigner.setInvestorStatus(addr, status);
                await tx.wait();
                showToast("Investor Status Updated!", "success");
            } catch(err) {
                console.error(err);
                showToast("Admin Action Failed", "error");
            }
        }

        async function executePushCapital() {
            const amount = document.getElementById('input-push-amount').value;
            if (!amount) return;

            try {
                // Pre-flight check for Idle Funds
                const totalAssets = await vaultContract.totalManagedAssets();
                const capitalInKernel = await vaultContract.capitalInKernel();
                const idle = totalAssets.sub(capitalInKernel);
                const pushWei = ethers.utils.parseUnits(amount, 6);

                if (pushWei.gt(idle)) {
                    const idleFmt = ethers.utils.formatUnits(idle, 6);
                    showToast(`Insufficient Idle Funds (Max: $${formatMoney(idleFmt)})`, "error");
                    return;
                }

                showToast("Pushing Capital to Kernel...");
                
                // Add Gas Limit
                const overrides = { gasLimit: 2500000 };
                const tx = await vaultContractSigner.pushCapitalToKernel(pushWei, overrides);
                await tx.wait();
                showToast("Capital Pushed Successfully!", "success");
                // Clear input
                document.getElementById('input-push-amount').value = "";
                loadEcosystemData(); // refresh TVL stats
            } catch(err) {
                console.error(err);
                showToast("Push Failed", "error");
            }
        }

        async function executeDeployCapital() {
            const solver = document.getElementById('input-loan-solver').value;
            const amount = document.getElementById('input-loan-amount').value;
            const ref = document.getElementById('input-loan-ref').value || "LOAN-" + Date.now();

            if(!ethers.utils.isAddress(solver)) return showToast("Invalid Solver Address", "error");
            if(!amount) return;

            try {
                // Pre-flight check: Kernel must have enough USDC to deploy
                const kernelBal = await usdcContract.balanceOf(kernelAddress);
                const loanWei = ethers.utils.parseUnits(amount, 6);

                if (loanWei.gt(kernelBal)) {
                    const balFmt = ethers.utils.formatUnits(kernelBal, 6);
                    showToast(`Insufficient Kernel Liquidity (Max: $${formatMoney(balFmt)})`, "error");
                    return;
                }

                showToast("Deploying Capital...");
                
                // Admin (Owner) calls this on Kernel
                const overrides = { gasLimit: 2500000 };
                const tx = await kernelContractSigner.deployCapital(solver, loanWei, ref, overrides);
                await tx.wait();
                
                showToast("Capital Deployed Successfully!", "success");
                // Clear inputs
                document.getElementById('input-loan-amount').value = "";
                document.getElementById('input-loan-ref').value = "";
                loadEcosystemData(); // refresh stats
            } catch(err) {
                console.error(err);
                showToast("Deployment Failed (Check allowance/balance)", "error");
            }
        }

        async function checkSolver() {
            const addr = document.getElementById('input-solver-addr').value;
            if(!ethers.utils.isAddress(addr)) return showToast("Invalid Address", "error");

            try {
                const isWhitelisted = await kernelContract.whitelistedSolvers(addr);
                const principal = await kernelContract.activePrincipal(addr);
                
                const panel = document.getElementById('solver-result');
                const statusText = document.getElementById('solver-status-text');
                const statusIcon = document.getElementById('solver-status-icon');
                const prinText = document.getElementById('solver-principal');
                document.getElementById('solver-addr-display').innerText = addr;

                panel.classList.remove('hidden');

                if(isWhitelisted) {
                    statusText.innerText = "Whitelisted";
                    statusText.classList.remove('text-red-600');
                    statusText.classList.add('text-green-600');
                    statusIcon.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>`;
                    statusIcon.className = "w-8 h-8 rounded-full bg-green-100 flex items-center justify-center";
                } else {
                    statusText.innerText = "Not Whitelisted";
                    statusText.classList.add('text-red-600');
                    statusText.classList.remove('text-green-600');
                    statusIcon.innerHTML = `<i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>`;
                    statusIcon.className = "w-8 h-8 rounded-full bg-red-100 flex items-center justify-center";
                }

                const prinFmt = ethers.utils.formatUnits(principal, 6);
                prinText.innerText = `$${formatMoney(prinFmt)}`;
                lucide.createIcons();
            } catch(err) { console.error(err); showToast("Check failed", "error"); }
        }

        // --- SHARED ACTIONS (TOPUP/TRANSFER/ETC) ---
        // (Existing functions kept as is)
        function fillMax(inputId, type) {
            const input = document.getElementById(inputId);
            if (!input) return;
            if (type === 'checking') input.value = currentCheckingBal;
            else if (type === 'savings-dynamic') {
                if (currentSavingsAction === 'deposit') input.value = currentCheckingBal;
                else input.value = currentSavingsBal;
            }
        }

        async function executeTopUp() {
            const amount = document.getElementById('input-topup').value;
            if (!amount) return;
            try {
                const wei = ethers.utils.parseUnits(amount, 6);
                const tx = await usdcContract.transfer(accountAddress, wei);
                toggleModal('modal-topup');
                showToast("Top up submitted...");
                await tx.wait();
                showToast("Funds deposited!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Transfer failed", "error"); }
        }

        function openTransferModal() { toggleModal('modal-transfer'); }

        async function executeTransfer() {
            const to = document.getElementById('input-transfer-to').value;
            const amount = document.getElementById('input-transfer-amount').value;
            if (!to || !amount) return;
            // Pre-flight Check
            if (parseFloat(amount) > parseFloat(currentCheckingBal)) {
                showToast("Insufficient Balance", "error");
                return;
            }
            try {
                // Add Gas Limit
                const wei = ethers.utils.parseUnits(amount, 6);
                const tx = await accountContract.pay(to, wei, { gasLimit: 250000 });
                toggleModal('modal-transfer');
                showToast("Processing payment...");
                await tx.wait();
                showToast("Payment sent!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Payment failed", "error"); }
        }

        function openSavingsModal(type) {
            currentSavingsAction = type;
            const btn = document.getElementById('savings-btn');
            const title = document.getElementById('savings-title');
            const desc = document.getElementById('savings-desc');
            document.getElementById('input-savings-amount').value = "";
            
            if (type === 'deposit') {
                title.innerText = "Invest in Vault"; desc.innerText = "Move USDC from Checking to Savings.";
                btn.innerText = "Confirm Deposit"; btn.className = "w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium transition-colors";
            } else {
                title.innerText = "Withdraw Funds"; desc.innerText = "Burn shares to redeem USDC to Checking.";
                btn.innerText = "Confirm Withdraw"; btn.className = "w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors";
            }
            toggleModal('modal-savings');
        }

        async function executeSavingsAction() {
            const amount = document.getElementById('input-savings-amount').value;
            if (!amount) return;
            
            // Pre-flight Check
            if (currentSavingsAction === 'deposit') {
                if (parseFloat(amount) > parseFloat(currentCheckingBal)) {
                    showToast("Insufficient Checking Balance", "error");
                    return;
                }
            } else {
                if (parseFloat(amount) > parseFloat(currentSavingsBal)) {
                    showToast("Insufficient Savings Balance", "error");
                    return;
                }
            }

            try {
                let tx;
                toggleModal('modal-savings');
                showToast("Interacting with Vault...");
                
                // Add Manual Gas Limit to Prevent Estimation Crashes
                const overrides = { gasLimit: 2500000 };

                // Whitelist Check before Transaction
                if(currentSavingsAction === 'deposit') {
                    const isWhitelisted = await vaultContract.isWhitelisted(accountAddress);
                    if(!isWhitelisted) {
                        showToast("Account not whitelisted by Admin!", "error");
                        return;
                    }
                    const wei = ethers.utils.parseUnits(amount, 6);
                    tx = await accountContract.depositToSavings(wei, 0, overrides); 
                } else {
                    const sharesWei = ethers.utils.parseUnits(amount, 6);
                    tx = await accountContract.withdrawFromSavings(sharesWei, 0, overrides);
                }
                await tx.wait();
                showToast("Vault Transaction Confirmed!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Vault Action Failed", "error"); }
        }

        async function executeSetLimit() {
            const amount = document.getElementById('input-limit').value;
            if (amount === '') return;
            try {
                const wei = ethers.utils.parseUnits(amount, 6);
                const tx = await accountContract.setDailyLimit(wei);
                toggleModal('modal-limit');
                showToast("Updating limit...");
                await tx.wait();
                showToast("Daily Limit Updated!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Update failed", "error"); }
        }

        // --- UTILS ---
        function toggleModal(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function formatMoney(amount) {
            return parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function setBtnLoading(id, isLoading) {
            const btn = document.getElementById(id);
            const txt = document.getElementById(id + '-text');
            const spin = document.getElementById(id + '-spinner');
            if (isLoading) { btn.disabled = true; txt.classList.add('hidden'); spin.classList.remove('hidden'); }
            else { btn.disabled = false; txt.classList.remove('hidden'); spin.classList.add('hidden'); }
        }

        function showToast(msg, type = 'info') {
            const el = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            msgEl.innerText = msg;
            if (type === 'error') icon.style.color = '#ef4444'; 
            else if (type === 'success') icon.style.color = '#10b981'; 
            else icon.style.color = '#60a5fa'; 
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { el.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }

        function copyAddress() {
            navigator.clipboard.writeText(accountAddress);
            showToast("Address copied to clipboard", "success");
        }
    </script>
</body>
</html>
