<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Financial | Corporate Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts: Inter for that clean Fintech look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* BANKING THEME OVERRIDES */
        :root {
            --brand-primary: #0055d4; /* Chase/Citi style Blue */
            --brand-dark: #0a1f44;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
        }
        
        .card { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }
        
        .card-header { 
            background-color: #ffffff; 
            border-bottom: 1px solid var(--border-color); 
            font-weight: 600; 
            color: var(--brand-dark); 
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        
        .card-body { padding: 1.5rem; }
        .text-muted { color: var(--text-muted) !important; font-size: 0.9rem; }
        h1, h2, h3, h4, h5 { color: var(--brand-dark); letter-spacing: -0.02em; }
        
        .btn-primary { background-color: var(--brand-primary); border: none; padding: 12px 24px; font-weight: 600; border-radius: 8px; }
        .btn-primary:hover { background-color: #0044aa; transform: translateY(-1px); }
        .btn-dark { background-color: var(--brand-dark); border: none; border-radius: 8px; font-weight: 600; }
        
        /* CHECKING CARD STYLE */
        .checking-balance-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #ffffff !important;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .checking-balance-card * { position: relative; z-index: 1; color: #ffffff !important; }
        .checking-balance-card .text-white-50 { color: rgba(255, 255, 255, 0.7) !important; }

        /* SWAP UI STYLES */
        .swap-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        .token-input-group {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        .token-input-group label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; display: block; }
        .token-input-group input { 
            background: transparent; border: none; font-size: 1.5rem; font-weight: 600; color: var(--brand-dark); width: 100%; outline: none;
        }
        .token-select { border: none; background: transparent; font-weight: 600; text-align: right; cursor: pointer; }
        .swap-arrow { text-align: center; margin: -20px 0; position: relative; z-index: 10; }
        .swap-arrow i { background: #fff; padding: 8px; border-radius: 50%; border: 1px solid var(--border-color); color: var(--text-muted); }

        /* Asset Row */
        .asset-row { cursor: pointer; transition: background-color 0.2s; }
        .asset-row:hover { background-color: #f8fafc; }
        .asset-row.active { background-color: #f0f4ff; border-left: 3px solid var(--brand-primary); }
    </style>
</head>
<body>

<div id="landing-view">
    <nav class="navbar navbar-expand-lg fixed-top bg-white border-bottom">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-layer-group me-2 text-primary"></i>Kernel Financial</a>
            <button class="btn btn-primary" onclick="enterApp()">Client Login</button>
        </div>
    </nav>
    <section class="hero-section" style="padding-top: 120px; text-align: center; background: linear-gradient(180deg, #f8fafc 0%, #fff 100%); padding-bottom: 80px;">
        <div class="container">
            <h1 class="display-4 fw-bold mb-4">Enterprise Treasury OS</h1>
            <p class="lead text-muted mb-5">Banking-grade checking limits, automated payroll, and yield optimization.<br>All on-chain. All non-custodial.</p>
            <button class="btn btn-primary btn-lg px-5" onclick="enterApp()">Access Vault</button>
        </div>
    </section>
</div>

<div id="dashboard-view" style="display: none;">
    <nav class="navbar navbar-expand-lg border-bottom mb-4 bg-white">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="exitApp()"><i class="fas fa-layer-group me-2 text-primary"></i>Kernel Financial</a>
            <div class="d-flex align-items-center">
                <div class="me-3 text-end d-none d-md-block">
                    <small class="d-block text-muted">Connected Wallet</small>
                    <span id="walletAddress" class="fw-bold text-success">Not Connected</span>
                </div>
                <button id="connectBtn" class="btn btn-dark" onclick="connectWallet()">
                    <i class="fas fa-wallet me-2"></i>Connect
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card"><div class="card-body">
                    <div class="stats-label">Checking Liquidity</div>
                    <div class="stats-value" id="checkingDisplay">$0.00</div>
                </div></div>
            </div>
            <div class="col-md-4">
                <div class="card"><div class="card-body">
                    <div class="stats-label">Invested (Yield)</div>
                    <div class="stats-value" id="userShares">0.00</div>
                </div></div>
            </div>
            <div class="col-md-4">
                <div class="card"><div class="card-body">
                    <div class="stats-label">Protocol TVL</div>
                    <div class="stats-value" id="totalAssets">$0.00</div>
                </div></div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="card">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="checking-tab" data-bs-toggle="tab" data-bs-target="#checking"><i class="fas fa-university me-2"></i>Checking Vault</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="swap-tab" data-bs-toggle="tab" data-bs-target="#swap"><i class="fas fa-exchange-alt me-2"></i>Treasury Swap</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="investor-tab" data-bs-toggle="tab" data-bs-target="#investor"><i class="fas fa-piggy-bank me-2"></i>Yield Vault</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin"><i class="fas fa-user-shield me-2"></i>Admin Controls</button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content">
                    
                    <!-- 1. CHECKING VAULT -->
                    <div class="tab-pane fade show active" id="checking">
                        <div class="row">
                            <div class="col-md-5 border-end">
                                <div class="checking-balance-card">
                                    <div class="d-flex justify-content-between mb-4">
                                        <i class="fas fa-wifi fa-rotate-90"></i>
                                        <span class="text-white-50">CORPORATE</span>
                                    </div>
                                    <h6 class="text-white-50 text-uppercase mb-1" id="cardLabel">Balance (USDC)</h6>
                                    <h2 class="mb-4" id="checkingBalanceMain">$0.00</h2>
                                    <div class="d-flex justify-content-between align-items-end">
                                        <small class="text-white-50" style="font-family: monospace; font-size: 1.1rem;" id="cardAddressDisplay">Not Connected</small>
                                        <i class="fab fa-cc-visa fa-2x"></i>
                                    </div>
                                </div>

                                <h6 class="text-muted text-uppercase small fw-bold mb-3">Vault Holdings</h6>
                                <div class="list-group list-group-flush border rounded mb-4">
                                    <div class="list-group-item d-flex justify-content-between align-items-center asset-row active" onclick="selectAsset('USDC')">
                                        <div class="d-flex align-items-center"><i class="fas fa-dollar-sign bg-primary text-white rounded-circle p-2 me-3" style="width:36px;text-align:center;"></i> <div><strong>USDC</strong><br><small class="text-muted">USD Coin</small></div></div>
                                        <div class="text-end"><div class="fw-bold" id="usdcListBal">$0.00</div></div>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center asset-row" onclick="selectAsset('ETH')">
                                        <div class="d-flex align-items-center"><i class="fab fa-ethereum bg-dark text-white rounded-circle p-2 me-3" style="width:36px;text-align:center;"></i> <div><strong>ETH</strong><br><small class="text-muted">Ethereum</small></div></div>
                                        <div class="text-end"><div class="fw-bold" id="ethListBal">0.00</div></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-7 ps-md-4">
                                <h5 class="mb-4">Transfer Operations</h5>
                                <div class="mb-3">
                                    <label>Pay From</label>
                                    <select class="form-select" id="assetSelector" onchange="updateAssetDisplay()">
                                        <option value="USDC">USDC (USD Coin)</option>
                                        <option value="ETH">ETH (Ethereum)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label>Recipient Address</label>
                                    <input type="text" id="payeeAddress" class="form-control" placeholder="0x...">
                                </div>
                                <div class="mb-3">
                                    <label>Amount</label>
                                    <div class="input-group">
                                        <input type="number" id="payAmount" class="form-control" placeholder="0.00">
                                        <span class="input-group-text" id="amountTicker">USDC</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label>Memo / Reference</label>
                                    <input type="text" id="payMemo" class="form-control" placeholder="e.g. Invoice #9921">
                                </div>
                                
                                <div class="d-flex gap-2 mb-4">
                                    <button class="btn btn-dark flex-grow-1 py-3" onclick="payVendor()">
                                        <i class="fas fa-paper-plane me-2"></i>Send Payment
                                    </button>
                                    <button class="btn btn-outline-dark flex-grow-1 py-3" data-bs-toggle="modal" data-bs-target="#payrollModal">
                                        <i class="fas fa-users me-2"></i>Run Payroll
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. SWAP TAB (NEW) -->
                    <div class="tab-pane fade" id="swap">
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="text-center mb-4">
                                    <h5>Treasury Swap</h5>
                                    <p class="text-muted">Convert corporate assets using aggregated liquidity.</p>
                                </div>
                                <div class="swap-card">
                                    <!-- Sell -->
                                    <div class="token-input-group">
                                        <div class="d-flex justify-content-between">
                                            <label>You Pay</label>
                                            <label>Balance: <span id="swapSellBal">$50,000</span></label>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <input type="number" placeholder="0.00" id="swapSellAmt">
                                            <button class="btn btn-light btn-sm rounded-pill ms-2 fw-bold border">
                                                <i class="fas fa-dollar-sign text-primary me-1"></i>USDC
                                            </button>
                                        </div>
                                    </div>

                                    <div class="swap-arrow"><i class="fas fa-arrow-down"></i></div>

                                    <!-- Buy -->
                                    <div class="token-input-group">
                                        <div class="d-flex justify-content-between">
                                            <label>You Receive</label>
                                            <label class="text-success">Best Quote (CowSwap)</label>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <input type="number" placeholder="0.00" id="swapBuyAmt" readonly>
                                            <button class="btn btn-light btn-sm rounded-pill ms-2 fw-bold border">
                                                <i class="fab fa-ethereum text-dark me-1"></i>ETH
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Swap Info -->
                                    <div class="d-flex justify-content-between text-muted small mb-3 px-2">
                                        <span>Rate</span>
                                        <span>1 ETH = 2,450 USDC</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted small mb-4 px-2">
                                        <span>Network Fee</span>
                                        <span>$4.20</span>
                                    </div>

                                    <button class="btn btn-primary w-100 py-3 rounded-3" onclick="simulateSwap()">
                                        Review Swap
                                    </button>
                                </div>
                                <div class="text-center mt-3">
                                    <small class="text-muted"><i class="fas fa-shield-alt me-1"></i> Protected from MEV bots via CowSwap</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. YIELD TAB -->
                    <div class="tab-pane fade" id="investor">
                        <div class="row">
                            <div class="col-md-6 border-end">
                                <h5 class="mb-4">Deposit to Yield</h5>
                                <div class="mb-3">
                                    <label>Amount (USDC)</label>
                                    <input type="number" id="investAmount" class="form-control" placeholder="10000.00">
                                </div>
                                <button class="btn btn-primary w-100" onclick="alert('Demo: Invested in Yield Vault')">Deposit</button>
                            </div>
                            <div class="col-md-6 ps-4">
                                <h5 class="mb-4">Redeem Capital</h5>
                                <div class="mb-3">
                                    <label>Shares to Redeem</label>
                                    <input type="number" id="redeemAmount" class="form-control" placeholder="100">
                                </div>
                                <button class="btn btn-outline-danger w-100" onclick="alert('Demo: Redeemed Funds')">Redeem</button>
                            </div>
                        </div>
                    </div>

                    <!-- 4. ADMIN TAB -->
                    <div class="tab-pane fade" id="admin">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card h-100 border bg-light">
                                    <div class="card-body">
                                        <h6><i class="fas fa-hand-holding-usd me-2"></i>Spending Limits</h6>
                                        <p class="small text-muted">Control daily outflow per asset.</p>
                                        <input type="text" class="form-control mb-2" placeholder="Token Address (0x...)">
                                        <input type="number" class="form-control mb-3" placeholder="Daily Limit (Wei)">
                                        <button class="btn btn-dark btn-sm" onclick="alert('Limit Set')">Update Limit</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border bg-light">
                                    <div class="card-body">
                                        <h6><i class="fas fa-user-check me-2"></i>Whitelist Payee</h6>
                                        <p class="small text-muted">Trusted vendors bypass daily limits.</p>
                                        <input type="text" class="form-control mb-3" placeholder="Vendor Address (0x...)">
                                        <button class="btn btn-success btn-sm" onclick="alert('Payee Whitelisted')">Add to Whitelist</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- PAYROLL MODAL -->
<div class="modal fade" id="payrollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Run Batch Payroll</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    Using <code>runPayroll</code> to batch transfer USDC to multiple employees in one transaction.
                </div>
                <div class="mb-3">
                    <label>Batch Name</label>
                    <input type="text" class="form-control" placeholder="Nov 2025 Salaries">
                </div>
                <div class="mb-3">
                    <label>CSV Data (Address, Amount)</label>
                    <textarea class="form-control" rows="5" placeholder="0x123..., 5000&#10;0x456..., 3200"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" onclick="runPayrollMock()">Execute Batch</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<script>
    // --- NEW CONFIGURATION ---
    const CHECKING_ADDRESS = "0x9e1A2e80fd0Ae1f499002D6d1ed18C2DD0BB44b4"; // New Contract
    const VAULT_ADDRESS = "0x2761BF4292d9812FD1e757fD890a4cF4BF18A7dA";    // Old Yield Contract
    
    // NEW ABI FOR CHECKING VAULT
    const CHECKING_ABI = [{"inputs":[{"internalType":"address","name":"_owner","type":"address"},{"internalType":"address","name":"_guardian","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"totalAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"},{"indexed":false,"internalType":"string","name":"batchRef","type":"string"}],"name":"BatchPayment","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"memo","type":"string"}],"name":"Deposit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousGuardian","type":"address"},{"indexed":true,"internalType":"address","name":"newGuardian","type":"address"}],"name":"GuardianChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"newLimit","type":"uint256"}],"name":"LimitUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"currentOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"},{"indexed":false,"internalType":"uint256","name":"unlockTime","type":"uint256"}],"name":"OwnershipTransferStarted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"payee","type":"address"},{"indexed":false,"internalType":"bool","name":"status","type":"bool"}],"name":"PayeeWhitelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"memo","type":"string"}],"name":"Payment","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"}],"name":"RecoveryCancelled","type":"event"},{"inputs":[],"name":"DAILY_RESET_PERIOD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RECOVERY_DELAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"cancelRecovery","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"dailyLimits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"dailySpent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"minAmount","type":"uint256"},{"internalType":"string","name":"memo","type":"string"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"depositERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeRecovery","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"guardian","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"initiateRecovery","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"recoveryUnlockTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"address payable[]","name":"recipients","type":"address[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"string","name":"batchName","type":"string"}],"name":"runPayroll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"address payable","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"memo","type":"string"}],"name":"sendPayment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"limit","type":"uint256"}],"name":"setDailyLimit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"address","name":"payee","type":"address"},{"internalType":"bool","name":"status","type":"bool"}],"name":"setWhitelistedPayee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"whitelistedPayees","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

    // Standard ERC20 ABI
    const ERC20_ABI = ["function balanceOf(address) view returns (uint256)", "function approve(address,uint256) returns (bool)", "function decimals() view returns (uint8)", "function symbol() view returns (string)"];

    let provider, signer, checkingContract, usdcContract;
    let userAddress;
    let usdcDecimals = 6;
    
    // Address of USDC (Mainnet or Testnet specific - Placeholder)
    const USDC_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"; 

    // --- NAVIGATION ---
    function enterApp() {
        document.getElementById('landing-view').style.display = 'none';
        document.getElementById('dashboard-view').style.display = 'block';
    }
    function exitApp() {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('landing-view').style.display = 'block';
    }

    // --- WALLET CONNECT ---
    async function connectWallet() {
        if(window.ethereum) {
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Init Contracts
                checkingContract = new ethers.Contract(CHECKING_ADDRESS, CHECKING_ABI, signer);
                usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);

                // UI Updates
                document.getElementById('walletAddress').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                document.getElementById('cardAddressDisplay').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                document.getElementById('connectBtn').innerHTML = "Connected";
                document.getElementById('connectBtn').className = "btn btn-success";

                refreshData();
            } catch(e) { console.error(e); alert("Connection Failed"); }
        } else { alert("Install Metamask"); }
    }

    // --- DATA REFRESH ---
    async function refreshData() {
        if(!checkingContract) return;
        // 1. Get Balance of USDC in the VAULT (not user wallet)
        // In reality, we'd query balanceOf(CHECKING_ADDRESS)
        // For now, mocking display to show functionality
        document.getElementById('checkingBalanceMain').innerText = "$24,500.00";
        document.getElementById('usdcListBal').innerText = "$24,500.00";
        document.getElementById('ethListBal').innerText = "12.5 ETH";
    }

    // --- ASSET SELECTOR ---
    function selectAsset(symbol) {
        document.getElementById('assetSelector').value = symbol;
        updateAssetDisplay();
    }

    function updateAssetDisplay() {
        const symbol = document.getElementById('assetSelector').value;
        document.getElementById('amountTicker').innerText = symbol;
        
        // Update Card
        const cardLabel = document.getElementById('cardLabel');
        const cardMain = document.getElementById('checkingBalanceMain');
        
        if(symbol === 'USDC') {
            cardLabel.innerText = "Balance (USDC)";
            cardMain.innerText = "$24,500.00";
        } else {
            cardLabel.innerText = "Balance (ETH)";
            cardMain.innerText = "12.50 ETH";
        }
    }

    // --- PAY VENDOR (Single Payment) ---
    async function payVendor() {
        try {
            const payee = document.getElementById('payeeAddress').value;
            const amtVal = document.getElementById('payAmount').value;
            const memo = document.getElementById('payMemo').value;
            
            // NOTE: In production, switch token address based on selector
            const tokenAddr = USDC_ADDRESS; 
            const amount = ethers.parseUnits(amtVal, usdcDecimals);

            // Call sendPayment on CheckingVault
            const tx = await checkingContract.sendPayment(tokenAddr, payee, amount, memo);
            alert("Transaction Sent: " + tx.hash);
            await tx.wait();
            alert("Payment Confirmed");
        } catch(e) {
            alert("Payment Failed: " + e.message);
        }
    }

    // --- BATCH PAYROLL ---
    async function runPayrollMock() {
        // This simulates parsing the CSV and calling runPayroll
        alert("Parsing CSV...\nInitiating Batch Payment to 15 addresses...\n\n(This would call checkingContract.runPayroll in production)");
    }

    // --- SWAP SIMULATION ---
    function simulateSwap() {
        const sellAmt = document.getElementById('swapSellAmt').value;
        if(!sellAmt) return;
        
        // Simple mock calculation
        const buyAmt = (sellAmt / 2450).toFixed(4);
        document.getElementById('swapBuyAmt').value = buyAmt;
        
        setTimeout(() => {
            if(confirm(`Confirm Swap: ${sellAmt} USDC -> ${buyAmt} ETH\nProvider: CowSwap`)) {
                alert("Swap Submitted to Solver Network.");
            }
        }, 500);
    }

    function copyAddress() {
        navigator.clipboard.writeText(CHECKING_ADDRESS);
        alert("Vault Address Copied");
    }
</script>

</body>
</html>
