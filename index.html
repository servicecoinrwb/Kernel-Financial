<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoBank | Future of Personal Finance</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .gradient-text {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .input-field {
            @apply w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all;
        }
        .nav-active {
            @apply text-blue-600 bg-blue-50;
        }
        .nav-inactive {
            @apply text-slate-500 hover:text-slate-800 hover:bg-slate-50;
        }
        .btc-gradient {
            background: linear-gradient(135deg, #F7931A 0%, #B36509 100%);
        }
        .bridge-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        .swap-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen relative overflow-x-hidden">

    <!-- Background Decoration -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-20%] left-[20%] w-[500px] h-[500px] bg-indigo-100 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Navigation -->
    <nav class="w-full px-6 py-4 flex justify-between items-center glass-panel sticky top-0 z-50">
        <div class="flex items-center gap-4 md:gap-8">
            <div class="flex items-center gap-2 mr-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">N</div>
                <span class="text-xl font-bold tracking-tight text-slate-900 hidden md:block">NeoBank</span>
            </div>
            
            <!-- Tab Switcher -->
            <div id="nav-tabs" class="hidden flex gap-1 md:gap-2 overflow-x-auto">
                <button onclick="switchView('dashboard')" id="tab-dashboard" class="nav-active px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i> My Account
                </button>
                <button onclick="switchView('wallet')" id="tab-wallet" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="wallet-2" class="w-4 h-4"></i> Wallet
                </button>
                <button onclick="switchView('deposit')" id="tab-deposit" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="arrow-down-circle" class="w-4 h-4"></i> Banking
                </button>
                <button onclick="switchView('bitcoin')" id="tab-bitcoin" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="bitcoin" class="w-4 h-4"></i> Bitcoin
                </button>
                <button onclick="switchView('ecosystem')" id="tab-ecosystem" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="network" class="w-4 h-4"></i> Ecosystem
                </button>
                <button onclick="switchView('solver')" id="tab-solver" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="briefcase" class="w-4 h-4"></i> Solver
                </button>
                <button onclick="switchView('admin')" id="tab-admin" class="nav-inactive px-3 md:px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i data-lucide="shield" class="w-4 h-4"></i> Admin
                </button>
            </div>
        </div>

        <div id="wallet-section">
            <button id="connect-btn" onclick="connectWallet()" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-full font-medium transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4"></i>
                <span class="hidden md:inline">Connect Wallet</span>
                <span class="md:hidden">Connect</span>
            </button>
            <div id="wallet-info" class="hidden flex items-center gap-4">
                <span id="user-address" class="text-sm font-medium text-slate-600 bg-white px-3 py-1.5 rounded-full border border-slate-200"></span>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- View: Landing / Connect -->
        <div id="view-landing" class="flex flex-col items-center justify-center min-h-[60vh] text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6 text-slate-900 tracking-tight">
                Banking, <span class="gradient-text">Reinvented</span> on Chain.
            </h1>
            <p class="text-lg text-slate-500 max-w-2xl mb-10 leading-relaxed">
                Your personal smart contract checking account. Earn yield directly from the Kernel, set daily spending limits, and own your financial infrastructure.
            </p>
            <button onclick="connectWallet()" class="bg-blue-600 hover:bg-blue-700 text-white text-lg px-8 py-4 rounded-full font-semibold transition-all shadow-xl shadow-blue-500/30 flex items-center gap-2">
                Get Started <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- View: Create Account -->
        <div id="view-create" class="hidden flex flex-col items-center justify-center min-h-[60vh] max-w-lg mx-auto text-center">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-6">
                <i data-lucide="user-plus" class="w-8 h-8"></i>
            </div>
            <h2 class="text-3xl font-bold mb-3 text-slate-900">Create Your Account</h2>
            <p class="text-slate-500 mb-8">
                Deploy your personal `CheckingAccount` smart contract. This will be your secure vault for managing assets and interacting with the ecosystem.
            </p>
            <button id="create-btn" onclick="createAccount()" class="w-full bg-slate-900 hover:bg-slate-800 text-white text-lg px-6 py-4 rounded-xl font-medium transition-all shadow-lg flex items-center justify-center gap-2">
                <span id="create-btn-text">Deploy Smart Account</span>
                <span id="create-btn-spinner" class="hidden">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                </span>
            </button>
        </div>

        <!-- View: Dashboard (My Account) -->
        <div id="view-dashboard" class="hidden">
            <!-- Header Info -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">My Account</h2>
                    <p class="text-slate-500 text-sm">Managing Smart Account: <span id="contract-address" class="font-mono text-blue-600 bg-blue-50 px-2 py-0.5 rounded ml-1 cursor-pointer" onclick="copyAddress()">0x...</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshData()" class="p-2 text-slate-400 hover:text-blue-600 transition-colors bg-white border border-slate-200 rounded-lg shadow-sm">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    <button onclick="toggleModal('modal-topup')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-md shadow-blue-500/20 flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Top Up
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Checking Balance -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="landmark" class="w-24 h-24 text-blue-600"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">Checking Balance</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-4">$<span id="bal-checking">0.00</span> <span class="text-lg text-slate-400 font-normal">USDC</span></h3>
                        <div class="flex gap-2">
                            <button onclick="openTransferModal()" class="flex-1 bg-slate-900 text-white text-sm py-2 rounded-lg hover:bg-slate-800 transition-colors">Transfer</button>
                        </div>
                    </div>
                </div>

                <!-- Savings Balance -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="piggy-bank" class="w-24 h-24 text-emerald-600"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">Savings Vault</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-4"><span id="bal-savings">0.00</span> <span class="text-lg text-slate-400 font-normal">Shares</span></h3>
                        <div class="flex gap-2">
                            <button onclick="openSavingsModal('deposit')" class="flex-1 bg-emerald-600 text-white text-sm py-2 rounded-lg hover:bg-emerald-700 transition-colors">Invest</button>
                            <button onclick="openSavingsModal('withdraw')" class="flex-1 bg-white border border-slate-200 text-slate-700 text-sm py-2 rounded-lg hover:bg-slate-50 transition-colors">Withdraw</button>
                        </div>
                    </div>
                </div>

                <!-- Token Swap -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="repeat" class="w-24 h-24 text-violet-600"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">Quick Swap</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-4">Exchange</h3>
                        <div class="flex gap-2">
                             <button onclick="openSwapModal()" class="w-full swap-gradient text-white text-sm py-2 rounded-lg font-medium shadow-md hover:opacity-90 transition-all flex items-center justify-center gap-2">
                                Swap Assets <i data-lucide="arrow-right-left" class="w-4 h-4"></i>
                             </button>
                        </div>
                        <div class="mt-2 flex justify-between items-center text-xs text-slate-400">
                            <span>Trade USDC, ETH, WBTC</span>
                        </div>
                    </div>
                </div>
                
                <!-- Security / Limits -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i data-lucide="shield-check" class="w-24 h-24 text-purple-600"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-sm font-medium text-slate-500">Daily Limit</p>
                            <button onclick="toggleModal('modal-limit')" class="text-xs text-blue-600 hover:underline">Edit</button>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="limit-daily">--</span></h3>
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                            <div id="limit-bar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500">Spent Today: $<span id="limit-spent">0.00</span></p>
                    </div>
                </div>
            </div>

            <!-- Activity List -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 min-h-[200px]">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-900">Recent Activity</h3>
                    <div id="activity-loading" class="hidden">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-slate-400"></i>
                    </div>
                </div>
                <div id="activity-list" class="space-y-4">
                    <!-- Activity items injected by JS -->
                    <div class="flex items-center justify-center text-slate-400 py-8 flex-col gap-2 opacity-50">
                        <i data-lucide="activity" class="w-8 h-8"></i>
                        <p>No transactions yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- View: Wallet (Personal EOA) -->
        <div id="view-wallet" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">My Wallet</h2>
                <p class="text-slate-500">Assets held in your connected personal wallet (Self-Custody).</p>
            </div>
            
            <!-- Wallet Card -->
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-8 mb-8">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                            <i data-lucide="wallet-2" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Connected Address</p>
                            <div class="flex items-center gap-2">
                                <h3 class="text-2xl font-bold text-slate-900 font-mono" id="wallet-addr-full">0x...</h3>
                                <button onclick="copyUserAddress()" class="p-1.5 hover:bg-slate-100 rounded-lg text-slate-400 transition-colors">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                     <div class="flex gap-3">
                         <a href="#" id="wallet-explorer-link" target="_blank" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 font-medium text-sm flex items-center gap-2">
                             View on Explorer <i data-lucide="external-link" class="w-3 h-3"></i>
                         </a>
                     </div>
                 </div>
            </div>
            
            <!-- Assets Grid -->
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- ETH -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center">
                             <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png?v=026" class="w-6 h-6" alt="ETH">
                        </div>
                        <div>
                            <p class="font-bold text-slate-900">Ethereum</p>
                            <p class="text-xs text-slate-500">ETH (Gas Token)</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-slate-900" id="wallet-bal-eth">0.0000</p>
                        <p class="text-xs text-slate-400">ETH</p>
                    </div>
                </div>
                
                <!-- USDC -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center">
                             <img src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png?v=026" class="w-6 h-6" alt="USDC">
                        </div>
                        <div>
                            <p class="font-bold text-slate-900">USD Coin</p>
                            <p class="text-xs text-slate-500">USDC</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-slate-900" id="wallet-bal-usdc">0.00</p>
                        <p class="text-xs text-slate-400">USDC</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 p-6 bg-blue-50 rounded-2xl border border-blue-100">
                <h4 class="font-bold text-blue-800 mb-2">Need to fund your account?</h4>
                <p class="text-sm text-blue-600 mb-4">Transfer funds from this wallet to your Smart Checking Account to start earning yield and using banking features.</p>
                <button onclick="toggleModal('modal-topup')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors text-sm">
                    Go to Top Up
                </button>
            </div>

        </div>
        
        <!-- View: Banking (Bridge/Fiat) -->
        <div id="view-deposit" class="hidden">
             <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900">Banking Services</h2>
                    <p class="text-slate-500">On-ramp, off-ramp, and bridge assets securely.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                
                <!-- Option 1: Cross-Chain Bridge -->
                <div class="bg-white rounded-3xl shadow-lg border border-slate-100 p-1 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-full h-2 bridge-gradient"></div>
                    <div class="p-8">
                        <div class="w-12 h-12 rounded-xl bridge-gradient flex items-center justify-center text-white mb-6 shadow-lg shadow-indigo-500/30">
                            <i data-lucide="arrow-left-right" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Bridge from Other Chain</h3>
                        <p class="text-sm text-slate-500 mb-6">Transfer USDC, ETH, or other tokens from Ethereum, Base, Optimism, or Polygon directly to your wallet on Arbitrum.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">From Network</label>
                                <select id="link-source-chain" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none font-medium">
                                    <option value="1">Ethereum Mainnet</option>
                                    <option value="8453">Base</option>
                                    <option value="10">Optimism</option>
                                    <option value="137">Polygon</option>
                                    <option value="56">BSC</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Asset to Bridge</label>
                                <select id="link-source-token" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none font-medium">
                                    <option value="USDC">USDC</option>
                                    <option value="ETH">ETH</option>
                                    <option value="USDT">USDT</option>
                                </select>
                            </div>
                            
                            <button onclick="openBridgeLink()" class="w-full bridge-gradient text-white py-4 rounded-xl font-bold text-lg transition-all shadow-lg hover:opacity-90 flex items-center justify-center gap-2 mt-4">
                                Bridge Now <i data-lucide="external-link" class="w-4 h-4"></i>
                            </button>
                            <p class="text-[10px] text-center text-slate-400">Opens Jumper.Exchange in new tab</p>
                        </div>
                    </div>
                </div>

                <!-- Option 2: Fiat On-Ramp -->
                <div class="bg-white rounded-3xl shadow-lg border border-slate-100 p-1 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-full h-2 bg-green-500"></div>
                    <div class="p-8">
                        <div class="w-12 h-12 rounded-xl bg-green-500 flex items-center justify-center text-white mb-6 shadow-lg shadow-green-500/30">
                            <i data-lucide="credit-card" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 mb-2">Buy with Card</h3>
                        <p class="text-sm text-slate-500 mb-6">Don't have crypto yet? Purchase USDC directly with your credit card or bank transfer via MoonPay.</p>
                        
                        <button onclick="openFiatLink('buy')" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg transition-all shadow-lg flex items-center justify-center gap-2 mt-8">
                            Buy Crypto <i data-lucide="external-link" class="w-4 h-4"></i>
                        </button>
                        <p class="text-[10px] text-center text-slate-400 mt-4">Powered by MoonPay</p>
                    </div>
                </div>
                
                <!-- Option 3: Sell to Exchange -->
                <div class="bg-white rounded-3xl shadow-lg border border-slate-100 p-1 overflow-hidden relative mt-8 md:mt-0 md:col-span-2">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-500"></div>
                    <div class="p-8 flex flex-col md:flex-row items-center gap-8">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-blue-500 flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                                    <i data-lucide="landmark" class="w-6 h-6"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-900">Send to Exchange</h3>
                            </div>
                            <p class="text-sm text-slate-500 mb-4">Withdraw USDC directly to your Coinbase, Robinhood, or Kraken deposit address on Arbitrum for instant liquidity.</p>
                            <p class="text-xs text-slate-400 flex items-center gap-1">
                                <i data-lucide="check-circle" class="w-3 h-3 text-green-500"></i> Fast Settlement
                                <span class="mx-2">â€¢</span>
                                <i data-lucide="check-circle" class="w-3 h-3 text-green-500"></i> Low Fees
                            </p>
                        </div>
                        <div>
                            <button onclick="openTransferModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all shadow-lg flex items-center gap-2">
                                Send to Exchange <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- View: Bitcoin Vault (Dedicated Page) -->
        <div id="view-bitcoin" class="hidden">
            <div class="mb-8 flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900">Bitcoin Vault</h2>
                    <p class="text-slate-500">Secure cold storage for native Bitcoin assets.</p>
                </div>
                <div class="px-4 py-2 bg-orange-50 border border-orange-100 rounded-full flex items-center gap-2">
                    <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold text-orange-700 uppercase tracking-wider">Bitcoin Mainnet</span>
                </div>
            </div>

            <!-- NEW: Setup State (Shown if no address) -->
            <div id="btc-setup" class="hidden max-w-md mx-auto bg-white p-8 rounded-3xl shadow-sm border border-slate-100 text-center mt-12">
                <div class="w-16 h-16 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="bitcoin" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Connect Bitcoin Treasury</h3>
                <p class="text-sm text-slate-500 mb-6">Enter your cold storage or monitoring address to track native Bitcoin assets on the mainnet.</p>
                
                <input type="text" id="input-btc-setup" placeholder="Enter BTC Address (e.g. bc1q...)" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-orange-500 outline-none text-center font-mono text-sm">
                
                <button onclick="saveBitcoinAddress()" class="w-full bg-[#F7931A] hover:bg-[#e0820b] text-white py-3 rounded-xl font-bold transition-colors shadow-lg shadow-orange-500/20 mb-4">
                    Link Address
                </button>
                
                <div>
                     <button onclick="useDemoAddress()" class="text-xs text-slate-400 hover:text-orange-500 underline">Use Demo Address</button>
                </div>
            </div>

            <!-- Existing Dashboard State (Wrapped in btc-dashboard) -->
            <div id="btc-dashboard" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main BTC Card -->
                <div class="lg:col-span-2 btc-gradient text-white p-8 rounded-3xl shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-20">
                        <i data-lucide="bitcoin" class="w-48 h-48 text-white"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-orange-100 font-medium mb-2">Total Bitcoin Balance</p>
                        <h3 class="text-5xl font-bold mb-6"><span id="bal-btc-main">0.00000000</span> <span class="text-2xl opacity-80">BTC</span></h3>
                        
                        <div class="flex flex-col sm:flex-row gap-4 mt-8">
                            <button onclick="toggleModal('modal-btc-deposit')" class="bg-white text-orange-600 px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-orange-50 transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="arrow-down-circle" class="w-5 h-5"></i> Deposit BTC
                            </button>
                            <button class="bg-orange-700/30 border border-white/20 text-white px-8 py-3 rounded-xl font-bold hover:bg-orange-700/50 transition-colors flex items-center justify-center gap-2 cursor-not-allowed opacity-70">
                                <i data-lucide="arrow-up-circle" class="w-5 h-5"></i> Withdraw (Cold Storage)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-bold text-slate-900 flex items-center gap-2">
                            <i data-lucide="info" class="w-5 h-5 text-slate-400"></i> Vault Details
                        </h4>
                        <button onclick="disconnectBitcoin()" class="text-xs text-red-400 hover:text-red-600 hover:underline">Unlink</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <p class="text-xs text-slate-500 mb-1">Deposit Address</p>
                            <p id="display-btc-address" class="text-xs font-mono font-bold text-slate-800 break-all select-all">--</p>
                        </div>
                        
                        <div class="flex items-start gap-3 p-3">
                            <i data-lucide="shield" class="w-5 h-5 text-green-600 mt-0.5"></i>
                            <div>
                                <p class="text-sm font-bold text-slate-800">Institutional Custody</p>
                                <p class="text-xs text-slate-500">Assets are held in offline cold storage. Not accessible via smart contracts.</p>
                            </div>
                        </div>

                        <div class="flex items-start gap-3 p-3">
                            <i data-lucide="clock" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                            <div>
                                <p class="text-sm font-bold text-slate-800">Settlement Time</p>
                                <p class="text-xs text-slate-500">Deposits credited after 2 network confirmations (~20 mins).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BTC Transaction History (Live) -->
            <div id="btc-tx-section" class="hidden mt-8">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Bitcoin Transactions</h3>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 min-h-[200px]">
                    <div id="btc-tx-loading" class="hidden flex justify-center py-8">
                         <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-orange-500"></i>
                    </div>
                    <div id="btc-tx-list" class="space-y-4">
                         <div class="flex items-center justify-center text-slate-400 py-8 flex-col gap-2 opacity-50">
                            <i data-lucide="history" class="w-8 h-8"></i>
                            <p>No transactions found.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Ecosystem (Vault & Kernel) -->
        <div id="view-ecosystem" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">Protocol Intelligence</h2>
                <p class="text-slate-500">Real-time data from the InvestorVault and Kernel Solvers.</p>
            </div>

            <!-- Global Vault Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- TVL -->
                <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-400 mb-1">Total Value Locked</p>
                        <h3 class="text-3xl font-bold mb-2">$<span id="eco-tvl">Loading...</span></h3>
                        <p class="text-xs text-slate-400">Total Assets Managed</p>
                    </div>
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="landmark" class="w-24 h-24"></i>
                    </div>
                </div>

                <!-- Idle Liquidity -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Vault Idle Liquidity</p>
                    <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="eco-idle">Loading...</span></h3>
                    <p class="text-xs text-blue-600 font-medium flex items-center gap-1">
                        <i data-lucide="info" class="w-3 h-3"></i> 
                        Available to Push
                    </p>
                </div>

                <!-- Share Price -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Share Price</p>
                    <h3 class="text-3xl font-bold text-slate-900 mb-2" id="eco-share-price">Loading...</h3>
                    <p class="text-xs text-green-600 font-medium flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-3 h-3"></i> 
                        1 Share = <span id="eco-share-ratio">--</span> USDC
                    </p>
                </div>

                <!-- Kernel Util -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-sm font-medium text-slate-500 mb-1">Capital Deployed</p>
                    <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="eco-deployed">Loading...</span></h3>
                    <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
                        <div id="eco-util-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Utilization: <span id="eco-util-pct">0%</span></p>
                </div>
                
                <!-- NEW: BTC Treasury Card -->
                <div class="bg-orange-50 p-6 rounded-2xl shadow-sm border border-orange-100 relative overflow-hidden lg:col-span-4">
                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-bold text-orange-800 mb-1">Cold Storage Reserves</p>
                            <h3 class="text-3xl font-bold text-slate-900"><span id="eco-btc-treasury">0.00000000</span> BTC</h3>
                            <p class="text-xs text-orange-600 font-medium mt-1">
                                Native Bitcoin held in Multisig Custody <span id="eco-btc-addr-hint" class="text-slate-400 font-mono ml-2 font-normal opacity-70 text-[10px]"></span>
                            </p>
                        </div>
                        <div class="hidden md:block">
                            <i data-lucide="lock" class="w-12 h-12 text-orange-300"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solver Inspector -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8">
                <div class="max-w-xl">
                    <h3 class="text-xl font-bold text-slate-900 mb-2 flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5 text-blue-600"></i> Solver Inspector
                    </h3>
                    <p class="text-sm text-slate-500 mb-6">Verify if an address is a whitelisted Solver and check their active debt principal.</p>
                    
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="input-solver-addr" placeholder="Solver Address (0x...)" class="flex-1 border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="checkSolver()" class="bg-slate-900 text-white px-6 py-3 rounded-lg font-medium hover:bg-slate-800 transition-colors">Check</button>
                    </div>

                    <!-- Result Panel -->
                    <div id="solver-result" class="hidden bg-slate-50 rounded-xl p-6 border border-slate-200">
                        <div class="flex items-center gap-3 mb-4">
                            <div id="solver-status-icon" class="w-8 h-8 rounded-full flex items-center justify-center">
                                <!-- Icon injected via JS -->
                            </div>
                            <div>
                                <h4 id="solver-status-text" class="font-bold text-slate-900">--</h4>
                                <p class="text-xs text-slate-500">Status</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wide">Active Principal</p>
                                <p id="solver-principal" class="text-lg font-mono font-medium text-slate-800">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wide">Address</p>
                                <p id="solver-addr-display" class="text-sm font-mono text-slate-600 truncate">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Solver (Loan Repayment) -->
        <div id="view-solver" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">Solver Portal</h2>
                <p class="text-slate-500">Manage your outstanding loans and repayments to the Kernel.</p>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Market Liquidity -->
                <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-400 mb-1">Available Liquidity</p>
                        <h3 class="text-3xl font-bold mb-2">$<span id="solver-available-liquidity">Loading...</span></h3>
                        <p class="text-xs text-slate-400">Funds ready for deployment (Vault)</p>
                    </div>
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="droplet" class="w-24 h-24"></i>
                    </div>
                </div>

                <!-- My Debt Position -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-sm font-medium text-slate-500 mb-1">My Active Debt</p>
                        <h3 class="text-3xl font-bold text-slate-900 mb-2">$<span id="my-principal">0.00</span></h3>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded">10% Fee</span>
                            <p class="text-xs text-slate-400">Applied on repayment</p>
                        </div>
                    </div>
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="alert-circle" class="w-24 h-24 text-orange-600"></i>
                    </div>
                </div>
            </div>

            <!-- Repay Form -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-2xl mx-auto">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Repay Loan</h3>
                
                <label class="block text-sm font-medium text-slate-700 mb-2">Principal to Repay</label>
                <input type="number" id="input-repay-principal" placeholder="0.00" oninput="calculateRepayment()" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div class="space-y-2 mb-6 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-500">Principal</span>
                        <span class="font-medium">$<span id="calc-principal">0.00</span></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Interest Fee (10%)</span>
                        <span class="font-medium text-orange-600">+$<span id="calc-fee">0.00</span></span>
                    </div>
                    <div class="pt-2 border-t border-slate-100 flex justify-between font-bold text-slate-900">
                        <span>Total Cost</span>
                        <span>$<span id="calc-total">0.00</span></span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="approveUSDCForKernel()" class="flex-1 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 py-3 rounded-lg font-medium transition-colors">1. Approve</button>
                    <button onclick="executeRepay()" class="flex-1 bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-medium transition-colors">2. Repay</button>
                </div>
            </div>
        </div>

        <!-- View: Admin (Whitelist & Operations) -->
        <div id="view-admin" class="hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-slate-900">Admin Console</h2>
                <p class="text-slate-500">Restricted access. Manage Kernel liquidity and permissions.</p>
            </div>

            <!-- System Upgrades (New - Kernel Governance) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto mb-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="cpu" class="w-24 h-24 text-slate-400"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">System Upgrades (Kernel)</h3>
                <p class="text-sm text-slate-500 mb-6">Propose and execute Kernel upgrades. Enforced by 24h Timelock.</p>

                <!-- Current Status -->
                <div class="bg-slate-50 rounded-lg p-4 mb-6 text-sm space-y-2 border border-slate-200">
                    <div class="flex justify-between">
                        <span class="text-slate-500">Current Kernel:</span>
                        <span class="font-mono text-slate-700 truncate w-48 text-right" id="adm-curr-kernel">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Pending Upgrade:</span>
                        <span class="font-mono text-blue-600 truncate w-48 text-right" id="adm-pending-kernel">None</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-500">Unlock Time:</span>
                        <span class="font-medium text-orange-600" id="adm-unlock-time">--</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Step 1: Propose -->
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">New Kernel Address</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-new-kernel" placeholder="0x..." class="flex-1 border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="executeProposeKernel()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">1. Propose</button>
                        </div>
                    </div>

                    <!-- Step 2: Execute -->
                    <button id="btn-upgrade-kernel" onclick="executeUpgradeKernel()" class="w-full bg-slate-200 text-slate-400 cursor-not-allowed py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2" disabled>
                        <i data-lucide="zap" class="w-4 h-4"></i> 2. Execute Upgrade (Wait for Timelock)
                    </button>
                </div>
            </div>

            <!-- Lending Operations (New) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto mb-8">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Lending Operations</h3>
                
                <!-- Fund Kernel removed. Using Issue Loan instead. -->
                
                <!-- Issue Loan -->
                <div>
                    <h4 class="font-semibold text-slate-800 mb-2">Issue Loan (Deploy Capital)</h4>
                    <p class="text-xs text-slate-500 mb-4">Disburse funds from Vault -> Kernel -> Solver automatically.</p>
                    
                    <label class="block text-xs font-medium text-slate-600 mb-1">Solver Address</label>
                    <input type="text" id="input-loan-solver" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm mb-3 focus:ring-2 focus:ring-blue-500 outline-none">
                    
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-600 mb-1">Amount</label>
                            <input type="number" id="input-loan-amount" placeholder="0.00" class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-600 mb-1">Invoice Ref</label>
                            <input type="text" id="input-loan-ref" placeholder="INV-001" class="w-full border border-slate-200 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    
                    <button onclick="executeDeployCapital()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i> Deploy Funds
                    </button>
                </div>
            </div>

            <!-- Manage Solvers (Existing) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto mb-8">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Manage Solvers</h3>
                
                <label class="block text-sm font-medium text-slate-700 mb-2">Solver Wallet Address</label>
                <input type="text" id="input-admin-solver" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-6 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setSolverStatus(true)" class="bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Whitelist
                    </button>
                    <button onclick="setSolverStatus(false)" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="ban" class="w-4 h-4"></i> Revoke
                    </button>
                </div>
            </div>

            <!-- Manage Investors (New) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 max-w-xl mx-auto">
                <h3 class="text-xl font-bold text-slate-900 mb-6">Manage Investors</h3>
                <p class="text-sm text-slate-500 mb-4">Whitelist user Checking Accounts to allow deposits into the Vault.</p>
                
                <label class="block text-sm font-medium text-slate-700 mb-2">Account Address</label>
                <input type="text" id="input-admin-investor" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-6 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setInvestorStatus(true)" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Whitelist
                    </button>
                    <button onclick="setInvestorStatus(false)" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="ban" class="w-4 h-4"></i> Revoke
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals (TopUp, Transfer, Savings, Limit, Toast, Swap) -->
    <!-- Swap Modal -->
    <div id="modal-swap" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-swap')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Swap Tokens</h3>
            <p class="text-sm text-slate-500 mb-6">Exchange USDC for other assets via Uniswap.</p>
            
            <div class="space-y-4">
                 <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Sell</p>
                    <div class="flex justify-between items-center">
                         <span class="font-bold text-lg text-slate-800">USDC</span>
                         <span class="text-sm text-slate-500">Arbitrum</span>
                    </div>
                 </div>
                 
                 <div class="flex justify-center -my-2">
                     <div class="bg-white p-1 rounded-full border border-slate-200 shadow-sm z-10">
                         <i data-lucide="arrow-down" class="w-4 h-4 text-slate-400"></i>
                     </div>
                 </div>

                 <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Buy</label>
                    <select id="swap-token-select" class="w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 outline-none font-medium">
                        <option value="ETH">ETH</option>
                        <option value="WBTC">WBTC</option>
                        <option value="ARB">ARB</option>
                    </select>
                </div>
                
                <button onclick="executeSwap()" class="w-full swap-gradient text-white py-3 rounded-xl font-bold text-lg transition-all shadow-lg hover:opacity-90 flex items-center justify-center gap-2 mt-4">
                    Proceed to Uniswap <i data-lucide="external-link" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Top Up Modal -->
    <div id="modal-topup" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-topup')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Top Up Account</h3>
            <label class="block text-sm font-medium text-slate-700 mb-2">Amount (USDC)</label>
            <input type="number" id="input-topup" placeholder="1000" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="executeTopUp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">Send Funds</button>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="modal-transfer" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-transfer')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Send Payment</h3>
            <label class="block text-sm font-medium text-slate-700 mb-2">Recipient Address</label>
            <input type="text" id="input-transfer-to" placeholder="0x..." class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <label class="block text-sm font-medium text-slate-700 mb-2">Amount (USDC)</label>
            <div class="relative mb-4">
                <input type="number" id="input-transfer-amount" placeholder="0.00" class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none pr-16">
                <button onclick="fillMax('input-transfer-amount', 'checking')" class="absolute right-2 top-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold px-2 py-1.5 rounded transition-colors">MAX</button>
            </div>
            <button onclick="executeTransfer()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-medium transition-colors">Confirm Transfer</button>
        </div>
    </div>

    <!-- Savings Modal -->
    <div id="modal-savings" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-savings')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 id="savings-title" class="text-xl font-bold mb-2">Invest in Vault</h3>
            <p id="savings-desc" class="text-sm text-slate-500 mb-4">Move funds to the Investor Kernel to earn yield.</p>
            <label class="block text-sm font-medium text-slate-700 mb-2">Amount</label>
            <div class="relative mb-2">
                <input type="number" id="input-savings-amount" placeholder="0.00" class="w-full border border-slate-200 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none pr-16">
                <button onclick="fillMax('input-savings-amount', 'savings-dynamic')" class="absolute right-2 top-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold px-2 py-1.5 rounded transition-colors">MAX</button>
            </div>
            <p class="text-xs text-slate-400 mb-4 text-right">Slippage protection enabled (1%)</p>
            <button id="savings-btn" onclick="executeSavingsAction()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium transition-colors">Confirm</button>
        </div>
    </div>

    <!-- Bitcoin Deposit Modal (NEW) -->
    <div id="modal-btc-deposit" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative text-center">
            <button onclick="toggleModal('modal-btc-deposit')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="bitcoin" class="w-8 h-8"></i>
            </div>
            
            <h3 class="text-xl font-bold mb-2">Deposit Native Bitcoin</h3>
            <p class="text-sm text-slate-500 mb-6">Send BTC to your dedicated Treasury Address via the <strong class="text-slate-900">Bitcoin Mainnet</strong>.</p>
            
            <!-- QR Placeholder -->
            <div class="w-48 h-48 bg-slate-100 mx-auto mb-6 rounded-lg flex items-center justify-center border border-slate-200 overflow-hidden">
                 <img id="btc-deposit-qr" alt="BTC Deposit QR" class="w-full h-full object-contain" src="">
            </div>

            <div class="bg-slate-100 p-4 rounded-xl mb-6">
                <p class="text-xs text-slate-500 mb-2">BTC Deposit Address (Native Segwit)</p>
                <p id="modal-btc-address" class="font-mono text-sm font-bold text-slate-800 break-all select-all">--</p>
            </div>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-left">
                <p class="text-xs text-red-800 font-medium flex items-start gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4 shrink-0"></i>
                    <span><strong>WARNING:</strong> Send only Native BTC. Do NOT send WBTC, BTCB, or Wrapped assets. They will be lost permanently.</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Limit Modal -->
    <div id="modal-limit" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="toggleModal('modal-limit')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold mb-4">Set Daily Spending Limit</h3>
            <p class="text-sm text-slate-500 mb-4">Protect your funds by capping daily outflows. Set to 0 to disable.</p>
            <label class="block text-sm font-medium text-slate-700 mb-2">Daily Limit (USDC)</label>
            <input type="number" id="input-limit" placeholder="1000" class="w-full border border-slate-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="executeSetLimit()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium transition-colors">Update Limit</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center gap-3">
        <i id="toast-icon" data-lucide="info" class="w-5 h-5 text-blue-400"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- CONFIGURATION ---
        const FACTORY_ADDRESS = "0x7090825ed699229Fe60E59163E439737E22b67dE";
        const RELAY_API_KEY = "YOUR_RELAY_API_KEY"; 
        
        // Minimal ABIs
        const FACTORY_ABI = [
            "function getAccount(address user) view returns (address)",
            "function createAccount() returns (address)",
            "function usdc() view returns (address)",
            "function INVESTOR_VAULT() view returns (address)",
            "function KERNEL() view returns (address)"
        ];

        const ACCOUNT_ABI = [
            "function getCheckingBalance() view returns (uint256)",
            "function getSavingsBalance() view returns (uint256)",
            "function pay(address to, uint256 amount)",
            "function depositToSavings(uint256 amount, uint256 minShares)",
            "function withdrawFromSavings(uint256 shareAmount, uint256 minAssets)",
            "function dailyLimit() view returns (uint256)",
            "function spentToday() view returns (uint256)",
            "function setDailyLimit(uint256 _limit)",
            "function usdc() view returns (address)",
            "event PaymentSent(address indexed to, uint256 amount)",
            "event DepositedToSavings(uint256 amount, uint256 sharesMinted)",
            "event WithdrawnFromSavings(uint256 sharesBurned, uint256 assetsReceived)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)"
        ];

        const VAULT_ABI = [
            "function totalManagedAssets() view returns (uint256)",
            "function totalShares() view returns (uint256)",
            "function capitalInKernel() view returns (uint256)",
            "function isWhitelisted(address) view returns (bool)",
            "function setInvestorStatus(address investor, bool status)",
            "function pushCapitalToKernel(uint256 amount)",
            "function owner() view returns (address)",
            "function proposeKernel(address _newKernel)",
            "function upgradeKernel()",
            "function pendingKernel() view returns (address)",
            "function kernelUpdateTime() view returns (uint256)",
            "function kernel() view returns (address)"
        ];

        const KERNEL_ABI = [
            "function whitelistedSolvers(address) view returns (bool)",
            "function activePrincipal(address) view returns (uint256)",
            "function repayLoan(uint256 principal, uint256 fee)",
            "function setSolver(address solver, bool status)",
            "function deployCapital(address solver, uint256 amount, string invoiceHash)",
            "function owner() view returns (address)"
        ];

        // --- STATE ---
        let provider, signer, userAddress;
        let factoryContract, accountContract, usdcContract;
        let vaultContract, vaultContractSigner, kernelContract, kernelContractSigner;
        let accountAddress = ethers.constants.AddressZero;
        let vaultAddress = ethers.constants.AddressZero;
        let kernelAddress = ethers.constants.AddressZero;
        let currentSavingsAction = 'deposit'; 
        let currentCheckingBal = "0";
        let currentSavingsBal = "0";
        let userBtcAddress = localStorage.getItem('neo_btc_address') || "";

        // --- INIT ---
        lucide.createIcons();

        // --- NAVIGATION ---
        function switchView(viewName) {
            const views = ['dashboard', 'deposit', 'bitcoin', 'ecosystem', 'solver', 'admin', 'wallet'];
            
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                const tab = document.getElementById('tab-' + v);
                
                if (v === viewName) {
                    el.classList.remove('hidden');
                    tab.classList.add('nav-active');
                    tab.classList.remove('nav-inactive');
                } else {
                    el.classList.add('hidden');
                    tab.classList.remove('nav-active');
                    tab.classList.add('nav-inactive');
                }
            });

            if(viewName === 'bitcoin') loadBitcoinView();
            if(viewName === 'ecosystem') { loadEcosystemData(); }
            if(viewName === 'solver') loadSolverData();
            if(viewName === 'admin') loadAdminData();
            if(viewName === 'wallet') loadWalletData();
        }
        
        function loadBitcoinView() {
            const setupEl = document.getElementById('btc-setup');
            const dashEl = document.getElementById('btc-dashboard');
            const txSection = document.getElementById('btc-tx-section');

            if (!userBtcAddress) {
                setupEl.classList.remove('hidden');
                dashEl.classList.add('hidden');
                txSection.classList.add('hidden');
            } else {
                setupEl.classList.add('hidden');
                dashEl.classList.remove('hidden');
                txSection.classList.remove('hidden');
                
                document.getElementById('display-btc-address').innerText = userBtcAddress;
                document.getElementById('modal-btc-address').innerText = userBtcAddress;
                
                const qrImg = document.getElementById('btc-deposit-qr');
                if(qrImg) {
                    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${userBtcAddress}`;
                }
                
                fetchBitcoinData();
            }
        }

        function saveBitcoinAddress() {
            const input = document.getElementById('input-btc-setup');
            const addr = input.value.trim();
            
            if (!addr) {
                showToast("Please enter a Bitcoin address", "error");
                return;
            }
            if (addr.length < 26 || (!addr.startsWith('1') && !addr.startsWith('3') && !addr.startsWith('bc1'))) {
                showToast("Invalid Bitcoin address format", "error");
                return;
            }

            userBtcAddress = addr;
            localStorage.setItem('neo_btc_address', addr);
            
            showToast("Address Linked!", "success");
            loadBitcoinView();
        }

        function disconnectBitcoin() {
            userBtcAddress = "";
            localStorage.removeItem('neo_btc_address');
            document.getElementById('input-btc-setup').value = ""; 
            showToast("Wallet Unlinked", "info");
            loadBitcoinView();
        }

        function useDemoAddress() {
            document.getElementById('input-btc-setup').value = "3545zePwogymE18dEqGUqv2qbKGmqfnF1u";
        }

        async function fetchBitcoinData() {
            if(!userBtcAddress) return;
            
            try {
                const response = await fetch(`https://mempool.space/api/address/${userBtcAddress}`);
                if (!response.ok) throw new Error("Failed to fetch BTC data");
                
                const data = await response.json();
                const funded = data.chain_stats.funded_txo_sum;
                const spent = data.chain_stats.spent_txo_sum;
                const balanceSats = funded - spent;
                const balanceBTC = (balanceSats / 100000000).toFixed(8);
                
                const balBtcMain = document.getElementById('bal-btc-main');
                const balBtcEco = document.getElementById('eco-btc-treasury');
                const hintEco = document.getElementById('eco-btc-addr-hint');
                
                if (balBtcMain) balBtcMain.innerText = balanceBTC;
                if (balBtcEco) balBtcEco.innerText = balanceBTC;
                if (hintEco) hintEco.innerText = `(${userBtcAddress.substring(0,4)}...${userBtcAddress.substring(userBtcAddress.length-4)})`;
                
                fetchBitcoinTransactions();
                
            } catch (error) {
                console.error("Error fetching Bitcoin data:", error);
            }
        }
        
        async function fetchBitcoinTransactions() {
            if(!userBtcAddress) return;
            
            const listEl = document.getElementById('btc-tx-list');
            const loader = document.getElementById('btc-tx-loading');
            if (!listEl) return;
            
            if (listEl.children.length <= 1 && loader) loader.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://mempool.space/api/address/${userBtcAddress}/txs`);
                if (!response.ok) throw new Error("Failed to fetch BTC txs");
                
                const txs = await response.json();
                if (loader) loader.classList.add('hidden');
                
                if (txs.length === 0) {
                     listEl.innerHTML = `<div class="flex items-center justify-center text-slate-400 py-8 flex-col gap-2 opacity-50"><i data-lucide="history" class="w-8 h-8"></i><p>No transactions found.</p></div>`;
                } else {
                     listEl.innerHTML = txs.slice(0, 10).map(tx => {
                        let isIncoming = false;
                        let amountSats = 0;
                        
                        for (const out of tx.vout) {
                            if (out.scriptpubkey_address === userBtcAddress) {
                                isIncoming = true;
                                amountSats += out.value;
                            }
                        }
                        
                        const amountBTC = (amountSats / 100000000).toFixed(8);
                        const txIdShort = `${tx.txid.substring(0, 6)}...${tx.txid.substring(tx.txid.length - 6)}`;
                        const time = tx.status.block_time ? new Date(tx.status.block_time * 1000).toLocaleDateString() : "Pending";
                        
                        let icon = isIncoming ? 'arrow-down-left' : 'arrow-up-right';
                        let colorClass = isIncoming ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600';
                        let title = isIncoming ? 'Received BTC' : 'Sent BTC';
                        
                        return `<div class="flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-100"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div><p class="font-semibold text-slate-800">${title}</p><p class="text-xs text-slate-500">${time} â€¢ <a href="https://mempool.space/tx/${tx.txid}" target="_blank" class="text-blue-500 hover:underline">${txIdShort}</a></p></div></div><div class="text-right"><p class="font-bold text-slate-900">${isIncoming ? '+' : '-'}${amountBTC} BTC</p><p class="text-xs text-slate-400">${tx.status.confirmed ? 'Confirmed' : 'Unconfirmed'}</p></div></div>`;
                    }).join('');
                }
                lucide.createIcons();
                
            } catch (error) {
                console.error("Error fetching BTC txs:", error);
                if (loader) loader.classList.add('hidden');
            }
        }
        
        // --- WALLET DATA FETCH ---
        async function loadWalletData() {
            if(!userAddress || !provider) return;
            
            // Address
            document.getElementById('wallet-addr-full').innerText = `${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}`;
            document.getElementById('wallet-explorer-link').href = `https://arbiscan.io/address/${userAddress}`;
            
            // ETH Balance
            const ethBal = await provider.getBalance(userAddress);
            document.getElementById('wallet-bal-eth').innerText = parseFloat(ethers.utils.formatEther(ethBal)).toFixed(4);
            
            // USDC Balance (Wallet)
            if(usdcContract) {
                const usdcBal = await usdcContract.balanceOf(userAddress);
                document.getElementById('wallet-bal-usdc').innerText = parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2);
            }
        }

        function copyUserAddress() {
            navigator.clipboard.writeText(userAddress);
            showToast("Wallet Address Copied!", "success");
        }
        
        // --- SMART LINKING (DEPOSIT) ---
        function openBridgeLink() {
            const chainId = document.getElementById('link-source-chain').value;
            const token = document.getElementById('link-source-token').value;
            
            if(!userAddress) {
                showToast("Please connect wallet first", "error");
                return;
            }
            
            const url = `https://jumper.exchange/?fromChain=${chainId}&fromToken=${token}&toChain=42161&toToken=0xaf88d065e77c8cC2239327C5EDb3A432268e5831&toAddress=${userAddress}`;
            window.open(url, '_blank');
        }
        
        function openFiatLink() {
             if(!userAddress) {
                showToast("Please connect wallet first", "error");
                return;
            }
            const url = `https://buy.moonpay.com?currencyCode=usdc_arbitrum&walletAddress=${userAddress}`;
            window.open(url, '_blank');
        }
        
        // --- SWAP FUNCTIONS ---
        function openSwapModal() {
            toggleModal('modal-swap');
        }
        
        function executeSwap() {
            const token = document.getElementById('swap-token-select').value;
            if(!userAddress) {
                showToast("Please connect wallet first", "error");
                return;
            }
            let outputToken = "ETH"; 
            if(token === 'WBTC') outputToken = '0x2f2a2543B76A4166549F7aaB2e75Bef0aefC5B0f';
            else if(token === 'ARB') outputToken = '0x912CE59144191C1204E64559FE8253a0e49E6548';
            
            const url = `https://app.uniswap.org/#/swap?inputCurrency=0xaf88d065e77c8cC2239327C5EDb3A432268e5831&outputCurrency=${outputToken}&chain=arbitrum`;
            window.open(url, '_blank');
            toggleModal('modal-swap');
        }

        // --- WALLET CONNECTION ---
        async function connectWallet() {
            if (!window.ethereum) return showToast("Metamask not found!", "error");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('wallet-info').classList.remove('hidden');
                document.getElementById('user-address').innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
                
                initContracts();
            } catch (err) {
                console.error(err);
                showToast("Connection failed", "error");
            }
        }

        async function initContracts() {
            factoryContract = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
            try {
                vaultAddress = await factoryContract.INVESTOR_VAULT();
                kernelAddress = await factoryContract.KERNEL();

                vaultContract = new ethers.Contract(vaultAddress, VAULT_ABI, provider);
                vaultContractSigner = new ethers.Contract(vaultAddress, VAULT_ABI, signer);
                kernelContract = new ethers.Contract(kernelAddress, KERNEL_ABI, provider);
                kernelContractSigner = new ethers.Contract(kernelAddress, KERNEL_ABI, signer);

                const acct = await factoryContract.getAccount(userAddress);
                if (acct !== ethers.constants.AddressZero) {
                    accountAddress = acct;
                    loadDashboard();
                    document.getElementById('nav-tabs').classList.remove('hidden');
                } else {
                    document.getElementById('view-landing').classList.add('hidden');
                    document.getElementById('view-create').classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
                showToast("Error initializing", "error");
            }
        }

        // --- CREATE ACCOUNT ---
        async function createAccount() {
            try {
                setBtnLoading('create-btn', true);
                const tx = await factoryContract.createAccount();
                showToast("Deploying Account... Please wait.");
                await tx.wait();
                const acct = await factoryContract.getAccount(userAddress);
                accountAddress = acct;
                setBtnLoading('create-btn', false);
                document.getElementById('view-create').classList.add('hidden');
                document.getElementById('nav-tabs').classList.remove('hidden');
                loadDashboard();
                showToast("Account Deployed Successfully!", "success");
            } catch (err) {
                console.error(err);
                setBtnLoading('create-btn', false);
                showToast("Deployment failed", "error");
            }
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            document.getElementById('view-landing').classList.add('hidden');
            document.getElementById('view-create').classList.add('hidden');
            switchView('dashboard');
            document.getElementById('contract-address').innerText = `${accountAddress.substring(0,6)}...${accountAddress.substring(38)}`;
            
            accountContract = new ethers.Contract(accountAddress, ACCOUNT_ABI, signer);
            const usdcAddr = await accountContract.usdc();
            usdcContract = new ethers.Contract(usdcAddr, ERC20_ABI, signer);

            refreshData();
            loadActivityFeed();
        }

        async function refreshData() {
            if (!accountContract) return;
            try {
                const checkingBalBN = await accountContract.getCheckingBalance();
                const savingsBalBN = await accountContract.getSavingsBalance();
                const limitBN = await accountContract.dailyLimit();
                const spentBN = await accountContract.spentToday();

                const checkingFmt = ethers.utils.formatUnits(checkingBalBN, 6);
                const savingsFmt = ethers.utils.formatUnits(savingsBalBN, 6); 
                currentCheckingBal = checkingFmt;
                currentSavingsBal = savingsFmt;

                const limitFmt = ethers.utils.formatUnits(limitBN, 6);
                const spentFmt = ethers.utils.formatUnits(spentBN, 6);

                document.getElementById('bal-checking').innerText = formatMoney(checkingFmt);
                document.getElementById('bal-savings').innerText = formatMoney(savingsFmt);
                
                if (parseFloat(limitFmt) === 0) {
                    document.getElementById('limit-daily').innerText = "Unlimited";
                    document.getElementById('limit-bar').style.width = "0%";
                } else {
                    document.getElementById('limit-daily').innerText = formatMoney(limitFmt);
                    document.getElementById('limit-spent').innerText = formatMoney(spentFmt);
                    const pct = Math.min((parseFloat(spentFmt) / parseFloat(limitFmt)) * 100, 100);
                    document.getElementById('limit-bar').style.width = `${pct}%`;
                    if(pct > 90) document.getElementById('limit-bar').classList.add('bg-red-500');
                    else document.getElementById('limit-bar').classList.remove('bg-red-500');
                }
                loadActivityFeed();
            } catch (err) { console.error("Refresh failed", err); }
        }

        async function loadActivityFeed() {
            const listEl = document.getElementById('activity-list');
            const loader = document.getElementById('activity-loading');
            if(listEl.children.length <= 1) loader.classList.remove('hidden');

            try {
                const paymentFilter = accountContract.filters.PaymentSent();
                const depositFilter = accountContract.filters.DepositedToSavings();
                const withdrawFilter = accountContract.filters.WithdrawnFromSavings();

                const [pEvts, dEvts, wEvts] = await Promise.all([
                    accountContract.queryFilter(paymentFilter),
                    accountContract.queryFilter(depositFilter),
                    accountContract.queryFilter(withdrawFilter)
                ]);

                const allEvents = [
                    ...pEvts.map(e => ({ type: 'payment', block: e.blockNumber, hash: e.transactionHash, amount: ethers.utils.formatUnits(e.args.amount, 6), to: e.args.to })),
                    ...dEvts.map(e => ({ type: 'deposit', block: e.blockNumber, hash: e.transactionHash, amount: ethers.utils.formatUnits(e.args.amount, 6) })),
                    ...wEvts.map(e => ({ type: 'withdraw', block: e.blockNumber, hash: e.transactionHash, amount: ethers.utils.formatUnits(e.args.assetsReceived, 6) }))
                ];

                allEvents.sort((a, b) => b.block - a.block);

                if (allEvents.length === 0) {
                     listEl.innerHTML = `<div class="flex items-center justify-center text-slate-400 py-8 flex-col gap-2 opacity-50"><i data-lucide="activity" class="w-8 h-8"></i><p>No transactions yet</p></div>`;
                } else {
                    listEl.innerHTML = allEvents.map(evt => {
                        let icon, title, desc, colorClass;
                        if (evt.type === 'payment') { icon='arrow-up-right'; colorClass='bg-slate-100 text-slate-600'; title='Transfer Sent'; desc=`To: ${evt.to.substring(0,6)}...`; }
                        else if (evt.type === 'deposit') { icon='piggy-bank'; colorClass='bg-emerald-100 text-emerald-600'; title='Invested in Vault'; desc='Moved to Savings'; }
                        else { icon='arrow-down-left'; colorClass='bg-blue-100 text-blue-600'; title='Withdrawn from Vault'; desc='Moved to Checking'; }
                        
                        return `<div class="flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-100">
                            <div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                            <div><p class="font-semibold text-slate-800">${title}</p><p class="text-xs text-slate-500">${desc}</p></div></div>
                            <div class="text-right"><p class="font-bold text-slate-900">${evt.type==='withdraw'?'+':'-'}$${formatMoney(evt.amount)}</p><a href="https://etherscan.io/tx/${evt.hash}" target="_blank" class="text-xs text-blue-500 hover:underline">View Tx</a></div></div>`;
                    }).join('');
                }
                lucide.createIcons();
                
            } catch (error) {
                console.error("Error loading activity", err);
                if (loader) loader.classList.add('hidden');
            }
        }

        // --- ECOSYSTEM ---
        async function loadEcosystemData() {
            if(!vaultContract) return;
            try {
                const totalAssets = await vaultContract.totalManagedAssets();
                const totalShares = await vaultContract.totalShares();
                const capitalInKernel = await vaultContract.capitalInKernel();

                const assetsFmt = parseFloat(ethers.utils.formatUnits(totalAssets, 6));
                const sharesFmt = parseFloat(ethers.utils.formatUnits(totalShares, 6));
                let price = 1.0;
                if(sharesFmt > 0) price = assetsFmt / sharesFmt;

                const kernelFmt = parseFloat(ethers.utils.formatUnits(capitalInKernel, 6));
                let util = 0;
                if(assetsFmt > 0) util = (kernelFmt / assetsFmt) * 100;

                // Calculate Idle Liquidity (Vault Balance)
                const vaultBal = await usdcContract.balanceOf(vaultAddress);
                const idleFmt = parseFloat(ethers.utils.formatUnits(vaultBal, 6));

                document.getElementById('eco-tvl').innerText = formatMoney(assetsFmt);
                document.getElementById('eco-deployed').innerText = formatMoney(kernelFmt);
                
                const idleEl = document.getElementById('eco-idle');
                if(idleEl) idleEl.innerText = formatMoney(idleFmt);
                
                document.getElementById('eco-share-price').innerText = "$" + price.toFixed(4);
                document.getElementById('eco-share-ratio').innerText = price.toFixed(4);
                document.getElementById('eco-util-bar').style.width = `${util}%`;
                document.getElementById('eco-util-pct').innerText = `${util.toFixed(1)}%`;
                
                if(userBtcAddress) fetchBitcoinData();
            } catch(err) { console.error("Eco data failed", err); }
        }

        // --- SOLVER LOGIC ---
        async function loadSolverData() {
            if(!kernelContract || !userAddress) return;
            try {
                const principal = await kernelContract.activePrincipal(userAddress);
                const prinFmt = ethers.utils.formatUnits(principal, 6);
                document.getElementById('my-principal').innerText = formatMoney(prinFmt);

                // Fetch Available Liquidity from Kernel USDC Balance
                // FIX: Get Vault Balance instead of Kernel Balance as liquidity
                const vaultBal = await usdcContract.balanceOf(vaultAddress);
                const kernelBalFmt = ethers.utils.formatUnits(vaultBal, 6);
                document.getElementById('solver-available-liquidity').innerText = formatMoney(kernelBalFmt);

            } catch(err) { console.error("Solver data failed", err); }
        }

        function calculateRepayment() {
            const input = document.getElementById('input-repay-principal').value;
            const amount = parseFloat(input || 0);
            const fee = amount * 0.10;
            const total = amount + fee;
            document.getElementById('calc-principal').innerText = formatMoney(amount);
            document.getElementById('calc-fee').innerText = formatMoney(fee);
            document.getElementById('calc-total').innerText = formatMoney(total);
        }

        async function approveUSDCForKernel() {
            const amount = document.getElementById('input-repay-principal').value;
            if(!amount) return;
            const total = parseFloat(amount) * 1.10;
            const totalWei = ethers.utils.parseUnits(total.toFixed(6), 6);
            try {
                showToast("Approving USDC...");
                const tx = await usdcContract.approve(kernelAddress, totalWei);
                await tx.wait();
                showToast("Approved!", "success");
            } catch(err) { console.error(err); showToast("Approval failed", "error"); }
        }

        async function executeRepay() {
            const amount = document.getElementById('input-repay-principal').value;
            if(!amount) return;
            const principalWei = ethers.utils.parseUnits(amount, 6);
            const feeWei = principalWei.div(10); 
            try {
                showToast("Repaying Loan...");
                const tx = await kernelContractSigner.repayLoan(principalWei, feeWei);
                await tx.wait();
                showToast("Loan Repaid!", "success");
                loadSolverData();
                document.getElementById('input-repay-principal').value = "";
                calculateRepayment();
            } catch(err) { console.error(err); showToast("Repayment failed", "error"); }
        }

        // --- ADMIN LOGIC ---
        async function loadAdminData() {
            if(!vaultContract) return;
            try {
                const currentKernel = await vaultContract.kernel();
                const pendingKernel = await vaultContract.pendingKernel();
                const unlockTime = await vaultContract.kernelUpdateTime();

                document.getElementById('adm-curr-kernel').innerText = `${currentKernel.substring(0,6)}...${currentKernel.substring(38)}`;
                
                if(pendingKernel !== ethers.constants.AddressZero) {
                    document.getElementById('adm-pending-kernel').innerText = `${pendingKernel.substring(0,6)}...${pendingKernel.substring(38)}`;
                    const now = Math.floor(Date.now() / 1000);
                    if(now >= unlockTime) {
                        document.getElementById('adm-unlock-time').innerText = "Ready to Execute";
                        document.getElementById('adm-unlock-time').className = "font-medium text-green-600";
                        const btn = document.getElementById('btn-upgrade-kernel');
                        btn.disabled = false;
                        btn.className = "w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2";
                        btn.innerHTML = `<i data-lucide="zap" class="w-4 h-4"></i> 2. Execute Upgrade`;
                    } else {
                        const timeLeft = unlockTime - now;
                        const hours = Math.ceil(timeLeft / 3600);
                        document.getElementById('adm-unlock-time').innerText = `Locked (${hours}h remaining)`;
                    }
                } else {
                    document.getElementById('adm-pending-kernel').innerText = "None";
                    document.getElementById('adm-unlock-time').innerText = "--";
                }
            } catch(err) { console.error("Admin data failed", err); }
        }

        async function executeProposeKernel() {
            const newKernel = document.getElementById('input-new-kernel').value;
            if(!ethers.utils.isAddress(newKernel)) return showToast("Invalid Address", "error");
            try {
                showToast("Proposing Kernel Update...");
                const tx = await vaultContractSigner.proposeKernel(newKernel);
                await tx.wait();
                showToast("Proposal Submitted! (24h Lock)", "success");
                loadAdminData();
            } catch(err) { console.error(err); showToast("Proposal Failed", "error"); }
        }

        async function executeUpgradeKernel() {
            try {
                showToast("Executing Upgrade...");
                const tx = await vaultContractSigner.upgradeKernel();
                await tx.wait();
                showToast("Kernel Upgraded Successfully!", "success");
                loadAdminData();
            } catch(err) { console.error(err); showToast("Execution Failed (Check Timelock)", "error"); }
        }

        async function setSolverStatus(status) {
            const addr = document.getElementById('input-admin-solver').value;
            if(!ethers.utils.isAddress(addr)) return showToast("Invalid Address", "error");
            try {
                showToast(status ? "Whitelisting Solver..." : "Revoking Solver...");
                const tx = await kernelContractSigner.setSolver(addr, status);
                await tx.wait();
                showToast("Solver Status Updated!", "success");
            } catch(err) { console.error(err); showToast("Admin Action Failed", "error"); }
        }

        async function setInvestorStatus(status) {
            const addr = document.getElementById('input-admin-investor').value;
            if(!ethers.utils.isAddress(addr)) return showToast("Invalid Address", "error");
            try {
                showToast(status ? "Whitelisting Investor..." : "Revoking Investor...");
                const tx = await vaultContractSigner.setInvestorStatus(addr, status);
                await tx.wait();
                showToast("Investor Status Updated!", "success");
            } catch(err) { console.error(err); showToast("Admin Action Failed", "error"); }
        }

        // MANUAL PUSH REMOVED - Only allowing Automatic via Deploy

        async function executeDeployCapital() {
            const solver = document.getElementById('input-loan-solver').value;
            const amount = document.getElementById('input-loan-amount').value;
            const ref = document.getElementById('input-loan-ref').value || "LOAN-" + Date.now();
            if(!ethers.utils.isAddress(solver)) return showToast("Invalid Solver Address", "error");
            if(!amount) return;

            try {
                const vaultBal = await usdcContract.balanceOf(vaultAddress);
                const loanWei = ethers.utils.parseUnits(amount, 6);
                if (loanWei.gt(vaultBal)) {
                    const balFmt = ethers.utils.formatUnits(vaultBal, 6);
                    showToast(`Insufficient Vault Liquidity (Max: $${formatMoney(balFmt)})`, "error");
                    return;
                }
                showToast("Deploying Capital...");
                const overrides = { gasLimit: 2500000 };
                const tx = await kernelContractSigner.deployCapital(solver, loanWei, ref, overrides);
                await tx.wait();
                showToast("Capital Deployed Successfully!", "success");
                document.getElementById('input-loan-amount').value = "";
                loadEcosystemData(); 
            } catch(err) { console.error(err); showToast("Deployment Failed", "error"); }
        }

        async function checkSolver() {
            const addr = document.getElementById('input-solver-addr').value;
            if(!ethers.utils.isAddress(addr)) return showToast("Invalid Address", "error");
            try {
                const isWhitelisted = await kernelContract.whitelistedSolvers(addr);
                const principal = await kernelContract.activePrincipal(addr);
                const panel = document.getElementById('solver-result');
                const statusText = document.getElementById('solver-status-text');
                const statusIcon = document.getElementById('solver-status-icon');
                const prinText = document.getElementById('solver-principal');
                document.getElementById('solver-addr-display').innerText = addr;
                panel.classList.remove('hidden');
                if(isWhitelisted) {
                    statusText.innerText = "Whitelisted";
                    statusText.classList.remove('text-red-600'); statusText.classList.add('text-green-600');
                    statusIcon.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>`;
                    statusIcon.className = "w-8 h-8 rounded-full bg-green-100 flex items-center justify-center";
                } else {
                    statusText.innerText = "Not Whitelisted";
                    statusText.classList.add('text-red-600'); statusText.classList.remove('text-green-600');
                    statusIcon.innerHTML = `<i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>`;
                    statusIcon.className = "w-8 h-8 rounded-full bg-red-100 flex items-center justify-center";
                }
                const prinFmt = ethers.utils.formatUnits(principal, 6);
                prinText.innerText = `$${formatMoney(prinFmt)}`;
                lucide.createIcons();
            } catch(err) { console.error(err); showToast("Check failed", "error"); }
        }

        // --- SHARED UTILS ---
        function fillMax(inputId, type) {
            const input = document.getElementById(inputId);
            if (!input) return;
            if (type === 'checking') input.value = currentCheckingBal;
            else if (type === 'savings-dynamic') {
                if (currentSavingsAction === 'deposit') input.value = currentCheckingBal;
                else input.value = currentSavingsBal;
            }
        }
        
        async function executeTopUp() {
            const amount = document.getElementById('input-topup').value;
            if (!amount) return;
            try {
                const wei = ethers.utils.parseUnits(amount, 6);
                const tx = await usdcContract.transfer(accountAddress, wei);
                toggleModal('modal-topup');
                showToast("Top up submitted...");
                await tx.wait();
                showToast("Funds deposited!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Transfer failed", "error"); }
        }

        function openTransferModal() { toggleModal('modal-transfer'); }
        async function executeTransfer() {
            const to = document.getElementById('input-transfer-to').value;
            const amount = document.getElementById('input-transfer-amount').value;
            if (!to || !amount) return;
            if (parseFloat(amount) > parseFloat(currentCheckingBal)) { showToast("Insufficient Balance", "error"); return; }
            try {
                const wei = ethers.utils.parseUnits(amount, 6);
                const tx = await accountContract.pay(to, wei, { gasLimit: 250000 });
                toggleModal('modal-transfer');
                showToast("Processing payment...");
                await tx.wait();
                showToast("Payment sent!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Payment failed", "error"); }
        }

        function openSavingsModal(type) {
            currentSavingsAction = type;
            const btn = document.getElementById('savings-btn');
            const title = document.getElementById('savings-title');
            const desc = document.getElementById('savings-desc');
            document.getElementById('input-savings-amount').value = "";
            if (type === 'deposit') {
                title.innerText = "Invest in Vault"; desc.innerText = "Move USDC from Checking to Savings.";
                btn.innerText = "Confirm Deposit"; btn.className = "w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-medium transition-colors";
            } else {
                title.innerText = "Withdraw Funds"; desc.innerText = "Burn shares to redeem USDC to Checking.";
                btn.innerText = "Confirm Withdraw"; btn.className = "w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors";
            }
            toggleModal('modal-savings');
        }

        async function executeSavingsAction() {
            const amount = document.getElementById('input-savings-amount').value;
            if (!amount) return;
            if (currentSavingsAction === 'deposit') {
                if (parseFloat(amount) > parseFloat(currentCheckingBal)) { showToast("Insufficient Checking Balance", "error"); return; }
            } else {
                if (parseFloat(amount) > parseFloat(currentSavingsBal)) { showToast("Insufficient Savings Balance", "error"); return; }
            }
            try {
                let tx;
                toggleModal('modal-savings');
                showToast("Interacting with Vault...");
                const overrides = { gasLimit: 2500000 };
                if(currentSavingsAction === 'deposit') {
                    const isWhitelisted = await vaultContract.isWhitelisted(accountAddress);
                    if(!isWhitelisted) { showToast("Account not whitelisted by Admin!", "error"); return; }
                    const wei = ethers.utils.parseUnits(amount, 6);
                    tx = await accountContract.depositToSavings(wei, 0, overrides); 
                } else {
                    const sharesWei = ethers.utils.parseUnits(amount, 6);
                    tx = await accountContract.withdrawFromSavings(sharesWei, 0, overrides);
                }
                await tx.wait();
                showToast("Vault Transaction Confirmed!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Vault Action Failed", "error"); }
        }

        async function executeSetLimit() {
            const amount = document.getElementById('input-limit').value;
            if (amount === '') return;
            try {
                const wei = ethers.utils.parseUnits(amount, 6);
                const tx = await accountContract.setDailyLimit(wei);
                toggleModal('modal-limit');
                showToast("Updating limit...");
                await tx.wait();
                showToast("Daily Limit Updated!", "success");
                refreshData();
            } catch (err) { console.error(err); showToast("Update failed", "error"); }
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function formatMoney(amount) { return parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function setBtnLoading(id, isLoading) {
            const btn = document.getElementById(id);
            const txt = document.getElementById(id + '-text');
            const spin = document.getElementById(id + '-spinner');
            if (isLoading) { btn.disabled = true; txt.classList.add('hidden'); spin.classList.remove('hidden'); }
            else { btn.disabled = false; txt.classList.remove('hidden'); spin.classList.add('hidden'); }
        }

        function showToast(msg, type = 'info') {
            const el = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');
            msgEl.innerText = msg;
            if (type === 'error') icon.style.color = '#ef4444'; 
            else if (type === 'success') icon.style.color = '#10b981'; 
            else icon.style.color = '#60a5fa'; 
            el.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { el.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }

        function copyAddress() {
            navigator.clipboard.writeText(accountAddress);
            showToast("Address copied to clipboard", "success");
        }
    </script>
</body>
</html>
