<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel | Institutional Banking</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    
    <!-- Web3Auth (CDN Version) - Dependencies FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/base@6.1.1/dist/base.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/ethereum-provider@6.1.1/dist/ethereumProvider.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@6.1.1/dist/modal.umd.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F3F4F6; }
        .chase-blue { background-color: #114285; }
        .chase-blue-text { color: #114285; }
        .sidebar-link.active { background-color: #E6F0FF; color: #114285; border-left: 4px solid #114285; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { ethers } = window;

        // --- CONFIGURATION ---
        const CLIENT_ID = "BM5XyP5tYq5TtEKAbtbtPf8aQkPwytH3X0LiUOFsgBfqB4HnkY39qbZXR_KeLvJMFjiGOF-GJQyE9tUBjuFgS_I";
        
        const ADDRESSES = {
            CHECKING: "0x9e1A2e80fd0Ae1f499002D6d1ed18C2DD0BB44b4",
            KERNEL: "0xC5ABA20edBF35544E5Adb9983b52831ec5d40FDD",
            INVESTOR_VAULT: "0x2761BF4292d9812FD1e757fD890a4cF4BF18A7dA",
            USDC: "0xaf88d065e77c8cC2239327C5EDb3A432268e5831" // Arbitrum USDC
        };

        const ABIS = {
            CHECKING: [
                "function sendPayment(address token, address recipient, uint256 amount, string memo)",
                "function runPayroll(address token, address[] recipients, uint256[] amounts, string batchName)",
                "function dailyLimits(address) view returns (uint256)",
                "function depositERC20(address token, uint256 amount, uint256 minAmount, string memo, uint256 deadline)"
            ],
            KERNEL: [
                "function deployCapital(address solver, uint256 amount, string invoiceHash)",
                "function setSolver(address solver, bool status)",
                "function whitelistedSolvers(address) view returns (bool)"
            ],
            INVESTOR: [
                "function deposit(uint256 amount, uint256 minShares)",
                "function withdraw(uint256 shareAmount, uint256 minAssets)",
                "function shares(address) view returns (uint256)",
                "function totalManagedAssets() view returns (uint256)",
                "function totalShares() view returns (uint256)"
            ],
            ERC20: [
                "function approve(address spender, uint256 amount) returns (bool)",
                "function balanceOf(address owner) view returns (uint256)",
                "function decimals() view returns (uint8)"
            ]
        };

        // --- ICONS COMPONENT WRAPPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState("");

            useEffect(() => {
                // Ensure Lucide is loaded and has icons
                if (window.lucide && window.lucide.icons) {
                    // Convert kebab-case (e.g., "credit-card") to PascalCase (e.g., "CreditCard")
                    // This is required because lucide.icons uses PascalCase keys
                    const iconKey = name
                        .split('-')
                        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                        .join('');

                    const iconData = window.lucide.icons[iconKey];

                    if (iconData) {
                        // Generate the SVG string using Lucide's toSvg method
                        // We apply dimensions here, but styling (className) is better handled by the wrapper
                        const svg = iconData.toSvg({
                            width: size,
                            height: size,
                            'stroke-width': 2 // Standard stroke width
                        });
                        setSvgHtml(svg);
                    } else {
                        console.warn(`Icon not found: ${name} (${iconKey})`);
                    }
                }
            }, [name, size]);

            // We render the SVG inside a span using dangerouslySetInnerHTML.
            // This prevents React from trying to reconcile the internal DOM nodes of the SVG,
            // avoiding the "removeChild" error.
            // We pass the className to this wrapper so margins/colors work correctly.
            return (
                <span 
                    className={`inline-flex items-center justify-center ${className}`}
                    dangerouslySetInnerHTML={{ __html: svgHtml }} 
                />
            );
        };

        // --- HELPER: FORMAT CURRENCY ---
        const formatUSDC = (wei) => {
            if (!wei) return "$0.00";
            const val = parseFloat(ethers.formatUnits(wei, 6));
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
        };

        // --- MAIN APP ---
        function App() {
            const [provider, setProvider] = useState(null);
            const [signer, setSigner] = useState(null);
            const [address, setAddress] = useState("");
            const [viewMode, setViewMode] = useState("personal"); // personal | commercial
            const [activeTab, setActiveTab] = useState("checking");

            // --- AUTH LOGIC ---
            const connectRabby = async () => {
                if (window.ethereum) {
                    try {
                        const browserProvider = new ethers.BrowserProvider(window.ethereum);
                        
                        // --- FORCE NETWORK SWITCH TO ARBITRUM ---
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0xa4b1' }], // Chain ID for Arbitrum One (42161)
                            });
                        } catch (switchError) {
                            // This error code indicates that the chain has not been added to MetaMask/Rabby.
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [
                                            {
                                                chainId: '0xa4b1',
                                                chainName: 'Arbitrum One',
                                                rpcUrls: ['https://arb1.arbitrum.io/rpc'],
                                                nativeCurrency: {
                                                    name: 'Ether',
                                                    symbol: 'ETH',
                                                    decimals: 18
                                                },
                                                blockExplorerUrls: ['https://arbiscan.io']
                                            },
                                        ],
                                    });
                                } catch (addError) {
                                    throw addError;
                                }
                            } else {
                                throw switchError;
                            }
                        }

                        await browserProvider.send("eth_requestAccounts", []);
                        const newSigner = await browserProvider.getSigner();
                        setProvider(browserProvider);
                        setSigner(newSigner);
                        setAddress(await newSigner.getAddress());
                    } catch (err) {
                        console.error(err);
                        alert("Connection failed: " + err.message);
                    }
                } else {
                    alert("Rabby or MetaMask not found!");
                }
            };

            const connectWeb3Auth = async () => {
                try {
                    // Check for UMD global namespace. Usually window.modal.Web3Auth or window.Web3Auth
                    const Web3AuthClass = (window.modal && window.modal.Web3Auth) || window.Web3Auth;

                    if(Web3AuthClass) {
                         const web3auth = new Web3AuthClass({
                            clientId: CLIENT_ID,
                            // Updated to Arbitrum One (Chain ID 42161 => 0xa4b1)
                            chainConfig: { 
                                chainNamespace: "eip155", 
                                chainId: "0xa4b1",
                                rpcTarget: "https://arb1.arbitrum.io/rpc",
                                displayName: "Arbitrum One",
                                blockExplorer: "https://arbiscan.io",
                                ticker: "ETH",
                                tickerName: "Ether",
                                logo: "https://images.toruswallet.io/arbitrum.svg"
                            }
                        });
                        await web3auth.initModal();
                        const web3authProvider = await web3auth.connect();
                        const browserProvider = new ethers.BrowserProvider(web3authProvider);
                        const newSigner = await browserProvider.getSigner();
                        setProvider(browserProvider);
                        setSigner(newSigner);
                        setAddress(await newSigner.getAddress());
                    } else {
                        console.error("Window globals:", window);
                        alert("Web3Auth library loading. Please try again or use Rabby. (Check Console for debug info)");
                    }
                } catch (error) {
                    console.error(error);
                    alert("Web3Auth Error: " + error.message);
                }
            };

            // --- LOGIN SCREEN ---
            if (!address) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center border-t-8 border-blue-900">
                            <div className="flex justify-center mb-6 text-blue-900">
                                <Icon name="shield" size={64} />
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Kernel Bank</h1>
                            <p className="text-gray-500 mb-8">Secure Institutional DeFi Gateway</p>
                            
                            <div className="space-y-4">
                                <button onClick={connectWeb3Auth} className="w-full bg-blue-900 text-white p-4 rounded-lg font-bold hover:bg-blue-800 transition flex items-center justify-center gap-3">
                                    <Icon name="mail" /> Sign in with Email / Social
                                </button>
                                <button onClick={connectRabby} className="w-full bg-orange-600 text-white p-4 rounded-lg font-bold hover:bg-orange-700 transition flex items-center justify-center gap-3">
                                    <Icon name="wallet" /> Connect Rabby Wallet
                                </button>
                            </div>
                            <p className="mt-6 text-xs text-gray-400">Secured by Web3Auth & Ethereum</p>
                        </div>
                    </div>
                );
            }

            // --- MAIN DASHBOARD ---
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="chase-blue text-white shadow-lg z-10">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <Icon name="shield" size={28} />
                                <span className="font-bold text-xl tracking-tight">KERNEL BANK</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="hidden md:flex text-xs bg-blue-800 px-3 py-1 rounded border border-blue-700">
                                    <span className="opacity-75 mr-2">Connected:</span>
                                    <span className="font-mono">{address.slice(0,6)}...{address.slice(-4)}</span>
                                </div>
                                <button 
                                    onClick={() => setViewMode(viewMode === 'personal' ? 'commercial' : 'personal')}
                                    className="bg-white text-blue-900 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-gray-100 transition uppercase tracking-wide"
                                >
                                    Switch to {viewMode === 'personal' ? 'Commercial' : 'Personal'}
                                </button>
                                <button onClick={() => window.location.reload()} className="hover:text-red-300">
                                    <Icon name="log-out" size={20} />
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="flex flex-1 max-w-7xl mx-auto w-full mt-6 px-4 gap-6">
                        {/* Sidebar */}
                        <aside className="w-64 hidden md:block">
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                <div className="p-4 bg-gray-50 border-b border-gray-100">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        {viewMode === 'personal' ? 'Personal Banking' : 'Commercial Center'}
                                    </h3>
                                </div>
                                <nav className="p-2 space-y-1">
                                    {viewMode === 'personal' ? (
                                        <>
                                            <SidebarItem label="Checking" icon="credit-card" active={activeTab === 'checking'} onClick={() => setActiveTab('checking')} />
                                            <SidebarItem label="Wealth Management" icon="trending-up" active={activeTab === 'investor'} onClick={() => setActiveTab('investor')} />
                                            <SidebarItem label="Transfers" icon="arrow-right-left" />
                                            <SidebarItem label="Statements" icon="file-text" />
                                        </>
                                    ) : (
                                        <>
                                            <SidebarItem label="Payroll Operations" icon="users" active={activeTab === 'payroll'} onClick={() => setActiveTab('payroll')} />
                                            <SidebarItem label="Credit Desk" icon="briefcase" active={activeTab === 'credit'} onClick={() => setActiveTab('credit')} />
                                            <SidebarItem label="Governance" icon="gavel" />
                                        </>
                                    )}
                                </nav>
                            </div>
                        </aside>

                        {/* Content Area */}
                        <main className="flex-1">
                            {viewMode === 'personal' ? (
                                activeTab === 'checking' ? <CheckingAccount signer={signer} address={address} /> : <InvestorVault signer={signer} address={address} />
                            ) : (
                                activeTab === 'payroll' || activeTab === 'checking' ? <PayrollManager signer={signer} /> : <CreditDesk signer={signer} />
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const SidebarItem = ({ label, icon, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md transition-colors ${active ? 'sidebar-link active' : 'text-gray-600 hover:bg-gray-50'}`}
            >
                <Icon name={icon} size={18} />
                {label}
            </button>
        );

        // --- COMPONENT: CHECKING ACCOUNT ---
        function CheckingAccount({ signer, address }) {
            const [recipient, setRecipient] = useState("");
            const [amount, setAmount] = useState("");
            const [balance, setBalance] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // Deposit State
            const [showDeposit, setShowDeposit] = useState(false);
            const [depositAmount, setDepositAmount] = useState("");

            // Fetch Live Balance
            useEffect(() => {
                const fetchBalance = async () => {
                    if (!signer) return;
                    try {
                        setLoading(true);
                        const usdc = new ethers.Contract(ADDRESSES.USDC, ABIS.ERC20, signer);
                        // The balance of the Checking Account is the USDC held by the Vault Contract
                        const bal = await usdc.balanceOf(ADDRESSES.CHECKING);
                        setBalance(bal);
                    } catch (err) {
                        console.error("Error fetching checking balance:", err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchBalance();
            }, [signer]);

            const handleSend = async () => {
                if(!signer) return;
                try {
                    const contract = new ethers.Contract(ADDRESSES.CHECKING, ABIS.CHECKING, signer);
                    const weiAmount = ethers.parseUnits(amount, 6); 
                    const tx = await contract.sendPayment(ADDRESSES.USDC, recipient, weiAmount, "Web Payment");
                    alert("Processing Payment...");
                    await tx.wait();
                    alert("Payment Sent!");
                } catch(e) { console.error(e); alert("Failed: " + e.message); }
            };

            const handleDeposit = async () => {
                if(!signer) return;
                try {
                    const usdc = new ethers.Contract(ADDRESSES.USDC, ABIS.ERC20, signer);
                    const checking = new ethers.Contract(ADDRESSES.CHECKING, ABIS.CHECKING, signer);
                    const wei = ethers.parseUnits(depositAmount, 6);
                    const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 hour deadline

                    alert("Step 1/2: Please sign USDC Approval...");
                    const approveTx = await usdc.approve(ADDRESSES.CHECKING, wei);
                    await approveTx.wait();

                    alert("Step 2/2: Depositing Funds...");
                    const tx = await checking.depositERC20(ADDRESSES.USDC, wei, 0, "Web Deposit", deadline);
                    await tx.wait();
                    
                    alert("Deposit Complete!");
                    setShowDeposit(false);
                    setDepositAmount("");
                } catch(e) { 
                    console.error(e); 
                    alert("Deposit Failed: " + (e.reason || e.message)); 
                }
            };

            return (
                <div className="space-y-6 relative">
                    {/* Deposit Modal Overlay */}
                    {showDeposit && (
                        <div className="absolute inset-0 z-20 bg-white/90 backdrop-blur-sm rounded-xl flex items-center justify-center p-6">
                            <div className="bg-white shadow-2xl border border-gray-200 p-6 rounded-xl w-full max-w-sm">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-gray-800">Add Money</h3>
                                    <button onClick={() => setShowDeposit(false)} className="text-gray-400 hover:text-red-500">
                                        <Icon name="x" size={24} />
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Amount to Deposit (USDC)</label>
                                        <input 
                                            type="number" 
                                            value={depositAmount}
                                            onChange={(e) => setDepositAmount(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-600 outline-none text-lg font-semibold"
                                            placeholder="0.00"
                                        />
                                    </div>
                                    <button 
                                        onClick={handleDeposit}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded font-bold transition flex items-center justify-center gap-2"
                                    >
                                        <Icon name="arrow-down-circle" size={18} /> Confirm Deposit
                                    </button>
                                    <p className="text-xs text-center text-gray-400">Transfers funds from your wallet to Checking Vault.</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 bg-gradient-to-r from-blue-900 to-blue-800 text-white">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-blue-200 text-sm font-medium">Kernel Checking Vault</p>
                                <h2 className="text-4xl font-bold mt-2">
                                    {loading ? "Loading..." : formatUSDC(balance)}
                                </h2>
                                <p className="text-blue-200 text-sm mt-1">Available Balance</p>
                            </div>
                            <Icon name="credit-card" size={32} className="text-blue-300 opacity-50" />
                        </div>
                        <div className="mt-6 flex gap-3">
                            <button onClick={() => setShowDeposit(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-semibold transition flex items-center gap-2">
                                <Icon name="plus" size={16} /> Add Money
                            </button>
                            <button className="bg-transparent border border-blue-400 hover:bg-blue-800 text-white px-4 py-2 rounded text-sm font-semibold transition">Statements</button>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Icon name="send" size={18} className="text-blue-600"/> Quick Transfer
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Recipient</label>
                                <input type="text" onChange={e => setRecipient(e.target.value)} placeholder="0x..." className="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-600 outline-none font-mono text-sm" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Amount (USDC)</label>
                                <input type="number" onChange={e => setAmount(e.target.value)} placeholder="0.00" className="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-600 outline-none" />
                            </div>
                        </div>
                        <button onClick={handleSend} className="mt-4 w-full bg-blue-900 text-white py-3 rounded font-bold hover:bg-blue-800 transition">
                            Send Payment
                        </button>
                    </div>
                </div>
            );
        }

        // --- COMPONENT: INVESTOR VAULT ---
        function InvestorVault({ signer, address }) {
            const [amount, setAmount] = useState("");
            const [withdrawAmount, setWithdrawAmount] = useState("");
            const [activeAction, setActiveAction] = useState("deposit"); // deposit | withdraw
            
            const [totalAssets, setTotalAssets] = useState(null);
            const [userShares, setUserShares] = useState(null);
            const [sharePrice, setSharePrice] = useState(0);

            // Fetch Vault Data
            useEffect(() => {
                const fetchData = async () => {
                    if (!signer) return;
                    try {
                        const vault = new ethers.Contract(ADDRESSES.INVESTOR_VAULT, ABIS.INVESTOR, signer);
                        
                        // 1. Get Total Assets in Vault
                        const assets = await vault.totalManagedAssets();
                        setTotalAssets(assets);

                        // 2. Get User Shares
                        const shares = await vault.shares(address);
                        setUserShares(shares);

                        // 3. Calculate Share Price (Assets / Shares)
                        const totShares = await vault.totalShares();
                        if (totShares > 0n) {
                            // Rough calc for display (Wei math should be done with BigInt in prod)
                            const price = parseFloat(ethers.formatUnits(assets, 6)) / parseFloat(ethers.formatUnits(totShares, 18));
                            setSharePrice(price);
                        } else {
                            setSharePrice(1);
                        }

                    } catch (e) {
                        console.error("Vault read error:", e);
                    }
                };
                fetchData();
            }, [signer, address]);

            // Calculate estimated value of user holdings
            const userValue = (userShares && totalAssets) 
                ? (parseFloat(ethers.formatUnits(userShares, 18)) * sharePrice) // Assuming standard share calc
                : 0;

            const handleDeposit = async () => {
                if(!signer) return;
                try {
                    const usdc = new ethers.Contract(ADDRESSES.USDC, ABIS.ERC20, signer);
                    const vault = new ethers.Contract(ADDRESSES.INVESTOR_VAULT, ABIS.INVESTOR, signer);
                    const wei = ethers.parseUnits(amount, 6);
                    
                    alert("Please sign Approval transaction...");
                    await (await usdc.approve(ADDRESSES.INVESTOR_VAULT, wei)).wait();
                    
                    alert("Processing Deposit...");
                    await (await vault.deposit(wei, 0)).wait();
                    alert("Deposit Successful!");
                    setAmount("");
                } catch(e) { console.error(e); alert("Failed: " + (e.reason || e.message)); }
            };

            const handleWithdraw = async () => {
                if(!signer) return;
                try {
                    const vault = new ethers.Contract(ADDRESSES.INVESTOR_VAULT, ABIS.INVESTOR, signer);
                    const weiShares = ethers.parseUnits(withdrawAmount, 18);
                    
                    alert("Processing Withdrawal...");
                    // 0 minAssets for demo (slippage protection recommended in prod)
                    await (await vault.withdraw(weiShares, 0)).wait();
                    alert("Withdrawal Successful!");
                    setWithdrawAmount("");
                } catch(e) { console.error(e); alert("Failed: " + (e.reason || e.message)); }
            };

            const setMaxWithdraw = () => {
                if(userShares) {
                    setWithdrawAmount(ethers.formatUnits(userShares, 18));
                }
            };

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold text-gray-700">Total Yield Assets (TVL)</h3>
                                <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">APY 8.5%</span>
                            </div>
                            <h2 className="text-3xl font-bold text-gray-900">
                                {formatUSDC(totalAssets)}
                            </h2>
                            <p className="text-sm text-gray-400 mt-1">Kernel Investor Vault</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col justify-center items-start">
                             <h3 className="font-bold text-gray-700 mb-2">Your Position</h3>
                             <div className="w-full mb-2">
                                <span className="text-2xl font-bold text-blue-900">
                                    {new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(userValue)}
                                </span>
                             </div>
                             <p className="text-xs text-gray-500">
                                Shares: {userShares ? parseFloat(ethers.formatUnits(userShares, 18)).toFixed(4) : "0.0000"}
                             </p>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        {/* Tab Switcher */}
                        <div className="flex border-b border-gray-100">
                            <button 
                                onClick={() => setActiveAction('deposit')}
                                className={`flex-1 py-4 font-bold text-sm uppercase tracking-wide transition ${activeAction === 'deposit' ? 'bg-white text-blue-900 border-b-2 border-blue-900' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}
                            >
                                Deposit Capital
                            </button>
                            <button 
                                onClick={() => setActiveAction('withdraw')}
                                className={`flex-1 py-4 font-bold text-sm uppercase tracking-wide transition ${activeAction === 'withdraw' ? 'bg-white text-orange-600 border-b-2 border-orange-600' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}
                            >
                                Withdraw Funds
                            </button>
                        </div>

                        <div className="p-6">
                            {activeAction === 'deposit' ? (
                                <div>
                                    <div className="flex gap-4 items-end">
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Deposit Amount (USDC)</label>
                                            <input 
                                                value={amount}
                                                onChange={e => setAmount(e.target.value)} 
                                                type="number" 
                                                className="w-full p-3 border border-gray-300 rounded focus:border-blue-500 outline-none font-semibold text-lg" 
                                                placeholder="0.00" 
                                            />
                                        </div>
                                        <button onClick={handleDeposit} className="bg-blue-900 hover:bg-blue-800 text-white px-8 py-3.5 rounded font-bold transition">
                                            Deposit
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-3 flex items-center gap-1">
                                        <Icon name="info" size={12}/> Requires 2 transactions (Approve + Deposit)
                                    </p>
                                </div>
                            ) : (
                                <div>
                                    <div className="flex gap-4 items-end">
                                        <div className="flex-1">
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-xs font-bold text-gray-500 uppercase">Withdraw Amount (Shares)</label>
                                                <button onClick={setMaxWithdraw} className="text-xs text-orange-600 font-bold hover:underline">MAX</button>
                                            </div>
                                            <input 
                                                value={withdrawAmount}
                                                onChange={e => setWithdrawAmount(e.target.value)} 
                                                type="number" 
                                                className="w-full p-3 border border-gray-300 rounded focus:border-orange-500 outline-none font-semibold text-lg" 
                                                placeholder="0.0000" 
                                            />
                                        </div>
                                        <button onClick={handleWithdraw} className="bg-white border border-orange-600 text-orange-600 hover:bg-orange-50 px-8 py-3.5 rounded font-bold transition">
                                            Withdraw
                                        </button>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-3 flex items-center gap-1">
                                        Approx Value: {withdrawAmount ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(parseFloat(withdrawAmount) * sharePrice) : '$0.00'}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENT: PAYROLL MANAGER (ADMIN) ---
        function PayrollManager({ signer }) {
            const [rows, setRows] = useState([{ addr: '', amt: '' }]);

            const addRow = () => setRows([...rows, { addr: '', amt: '' }]);
            const updateRow = (idx, field, val) => {
                const newRows = [...rows];
                newRows[idx][field] = val;
                setRows(newRows);
            }

            const executePayroll = async () => {
                if(!signer) return;
                try {
                    const contract = new ethers.Contract(ADDRESSES.CHECKING, ABIS.CHECKING, signer);
                    const addrs = rows.map(r => r.addr);
                    const amts = rows.map(r => ethers.parseUnits(r.amt || "0", 6));
                    
                    const tx = await contract.runPayroll(ADDRESSES.USDC, addrs, amts, "Web Batch");
                    alert("Payroll Batch Submitted");
                    await tx.wait();
                    alert("Batch Complete");
                } catch(e) { alert("Error: " + e.message); }
            }

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <Icon name="users" className="text-blue-900"/> Corporate Payroll
                        </h2>
                        <button onClick={executePayroll} className="bg-blue-900 text-white px-6 py-2 rounded font-bold hover:bg-blue-800">
                            Execute Batch
                        </button>
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-2">
                        {rows.map((row, i) => (
                            <div key={i} className="flex gap-2">
                                <span className="p-2 text-gray-400 font-mono text-sm">{i+1}.</span>
                                <input placeholder="Recipient Address" value={row.addr} onChange={e => updateRow(i, 'addr', e.target.value)} className="flex-1 p-2 border border-gray-300 rounded font-mono text-sm" />
                                <input placeholder="Amount" value={row.amt} onChange={e => updateRow(i, 'amt', e.target.value)} className="w-32 p-2 border border-gray-300 rounded text-right" type="number" />
                            </div>
                        ))}
                        <button onClick={addRow} className="text-sm text-blue-600 font-semibold mt-2 hover:underline">+ Add Employee</button>
                    </div>
                </div>
            );
        }

        // --- COMPONENT: CREDIT DESK (ADMIN) ---
        function CreditDesk({ signer }) {
            const [solver, setSolver] = useState("");
            const [amount, setAmount] = useState("");
            const [hash, setHash] = useState("");

            const deploy = async () => {
                if(!signer) return;
                try {
                    const kernel = new ethers.Contract(ADDRESSES.KERNEL, ABIS.KERNEL, signer);
                    const wei = ethers.parseUnits(amount, 6);
                    const tx = await kernel.deployCapital(solver, wei, hash);
                    await tx.wait();
                    alert("Capital Deployed");
                } catch(e) { alert("Error: " + e.message); }
            }

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <Icon name="briefcase" className="text-indigo-600"/> Credit Deployment
                    </h2>
                    <div className="space-y-4 max-w-xl">
                        <div>
                            <label className="block text-sm font-semibold text-gray-700">Solver Address</label>
                            <input onChange={e => setSolver(e.target.value)} className="w-full p-2 border border-gray-300 rounded font-mono" />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700">Principal (USDC)</label>
                            <input onChange={e => setAmount(e.target.value)} type="number" className="w-full p-2 border border-gray-300 rounded" />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700">Invoice Hash</label>
                            <input onChange={e => setHash(e.target.value)} className="w-full p-2 border border-gray-300 rounded" />
                        </div>
                        <button onClick={deploy} className="w-full bg-indigo-600 text-white font-bold py-3 rounded hover:bg-indigo-700">
                            Deploy Funds
                        </button>
                    </div>
                </div>
            );
        }

        // --- INIT REACT ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
